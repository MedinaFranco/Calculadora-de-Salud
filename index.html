<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de salud integral y mental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF6;
            color: #333333;
            padding-top: 80px; /* Espacio para el header fijo */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .input-group { @apply mb-4; }
        .input-group label { @apply block text-base font-bold text-gray-700 mb-2; }
        .input-group input, .input-group select, .input-group textarea { @apply w-full rounded-md border-gray-300 shadow-sm focus:border-[#6B8E23] focus:ring-[#6B8E23] p-2; }
        .hidden { display: none; }

        .interactive-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .interactive-card:hover {
            transform: scale(1.03);
            @apply shadow-xl;
        }

        #mobile-menu {
            transition: transform 0.3s ease-in-out;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        #meds-modal-content .accordion-content {
             transition: max-height 0.2s ease-in-out;
        }

        /* ===== ESTILOS MEJORADOS PARA LA CALCULADORA DE SALUD MENTAL ===== */
        .mh-step {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .mh-progress-bar-bg {
            background-color: #6B8E23;
            transition: width 0.5s ease-in-out;
        }
        
        /* Estilos para las tarjetas de resultados de salud mental */
        .mh-result-card {
             @apply bg-white p-6 rounded-lg shadow-md border-l-4 transition-all duration-300;
        }
        .mh-result-card.level-minima { @apply border-green-500; }
        .mh-result-card.level-baja { @apply border-green-500; }
        .mh-result-card.level-leve { @apply border-yellow-500; }
        .mh-result-card.level-normal { @apply border-blue-500; }
        .mh-result-card.level-promedio { @apply border-blue-500; }
        .mh-result-card.level-moderada { @apply border-orange-500; }
        .mh-result-card.level-moderadamente-severa { @apply border-orange-600; }
        .mh-result-card.level-alta { @apply border-red-500; }
        .mh-result-card.level-severa { @apply border-red-600; }

        @media print {
            .no-print { display: none !important; }
            body { background-color: #fff; padding-top: 0; }
            .printable-content { box-shadow: none !important; border: none !important; }
        }
    </style>
</head>
<body class="bg-[#FDFBF6]">

    <!-- ===== ENCABEZADO FIJO Y NAVEGACIÓN ===== -->
    <header class="fixed top-0 left-0 w-full bg-[#FDFBF6] bg-opacity-90 backdrop-blur-sm shadow-md z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Título a la Izquierda -->
                <div class="flex-shrink-0">
                    <a href="#" class="nav-link" data-section="inicio-section">
                        <h1 class="text-xl md:text-2xl font-bold text-[#6B8E23]">Calculadora de salud</h1>
                        <p class="text-xs text-gray-600 font-normal">Creado por Luis A. Medina Franco</p>
                    </a>
                </div>
                <!-- Menú de escritorio eliminado para unificar la experiencia con el menú desplegable -->
                
                <!-- Menú Hamburguesa a la Derecha (ahora visible en todas las pantallas) -->
                <div class="flex">
                    <button id="menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:bg-[#F7F9F4] focus:outline-none focus:ring-2 focus:ring-inset focus:ring-[#6B8E23]">
                        <span class="sr-only">Abrir menú</span>
                        <svg id="menu-open-icon" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        <svg id="menu-close-icon" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Menú desplegable para móviles -->
        <div id="mobile-menu" class="bg-white shadow-lg absolute w-full transform -translate-x-full">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50" data-section="inicio-section">Inicio</a>
                <a href="#" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50" data-section="quien-soy-section">Sobre mi</a>
                <a href="#" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50" data-section="metricas-section">Contenido</a>
                <!-- Dropdown para calculadoras -->
                <div>
                    <button class="accordion-header w-full flex justify-between items-center px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 text-left">
                        <span>Calculadoras</span>
                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content pl-4">
                        <div class="pt-2 pb-1 space-y-1">
                             <a href="#" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50" data-section="calculadora-section">Salud integral</a>
                             <a href="#" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50" data-section="mental-health-section">Salud mental</a>
                             <a href="#" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50" data-section="dosis-section">Dosis de medicamentos</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ===== CONTENEDOR PRINCIPAL DE SECCIONES ===== -->
    <main class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 pb-20 flex-grow">

        <!-- ===== SECCIÓN: ¿QUIÉN SOY? ===== -->
        <section id="quien-soy-section" class="page-section hidden bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-12 mb-8">
            <div class="text-center">
                 <h2 class="text-3xl font-bold text-[#6B8E23] mb-4">¡Hola, soy Luis!</h2>
            </div>
             <div class="text-lg text-gray-700 leading-relaxed space-y-4">
                <p>
                    Soy estudiante de medicina en la Universidad de Carabobo, en el corazón de Venezuela, y me apasiona explorar la encrucijada donde la salud, la tecnología y la humanidad convergen. Esta herramienta no es solo un ejercicio académico, ni una simple interfaz de cálculo. Es una extensión de una inquietud más profunda: comprender al ser humano a través de sus datos, sin reducirlo a ellos.
                </p>
                <p>
                    La medicina, para mí, no es únicamente diagnóstico y tratamiento. Es también escucha, interpretación, contexto. Esta plataforma intenta ser eso: un espacio donde lo cuantitativo se encuentra con lo cualitativo, donde el número se convierte en narrativa.
                </p>
                <p>
                    Cada fórmula aquí encierra una pregunta, cada resultado puede ser el inicio de una reflexión. Porque detrás de cada cifra hay un cuerpo, una historia, una voluntad.
                </p>
                 <p>
                    Si esta herramienta te orienta, si te invita a pensar, si te ofrece un instante de claridad en medio del ruido, entonces ya ha cumplido su propósito.
                 </p>
                 <p>
                    Y si además logra que te veas con otros ojos —más informados, más compasivos, más tuyos— entonces habrá valido la pena construirla.
                 </p>
            </div>
        </section>

        <!-- ===== SECCIÓN: INICIO ===== -->
        <section id="inicio-section" class="page-section bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-12 mb-8">
            <div class="text-center">
                 <h2 class="text-3xl font-bold text-[#6B8E23] mb-4">Una herramienta para ti y tu médico</h2>
            </div>
            <div class="text-lg text-gray-700 leading-relaxed space-y-4">
                <p>
                    Esta herramienta es un apoyo, no un reemplazo para tu médico. El objetivo es hacerte partícipe activo de tu salud, ofreciéndote datos para que puedas tener una conversación más rica e informada con tu profesional de confianza.
                </p>
                <p>
                    <span class="font-semibold">Para los pacientes,</span> es una guía, una motivación para tomar el control y un punto de partida para entender mejor su cuerpo. <span class="font-semibold">Para los profesionales de la salud,</span> es un recurso que puede agilizar la recopilación de índices y facilitar la educación del paciente, permitiendo visualizar rápidamente métricas clave.
                </p>
                <p>
                    El verdadero poder de esta calculadora se manifiesta en el trabajo en conjunto. Les invito —tanto a pacientes como a profesionales— a usar estos resultados como una base para el diálogo. Que sirvan como punto de partida para que, como un verdadero equipo, puedan tomar las riendas del bienestar de una forma más consciente, colaborativa y, en definitiva, más humana.
                </p>
            </div>
        </section>

        <!-- ===== SECCIÓN: MÉTRICAS ===== -->
        <section id="metricas-section" class="page-section hidden bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-12 mb-8">
            <h2 class="text-3xl font-bold text-center text-[#6B8E23] mb-8">Glosario de métricas de salud</h2>
            <div class="space-y-4">
                <!-- SALUD INTEGRAL -->
                <div>
                    <h3 class="text-2xl font-bold text-gray-900 mt-6 mb-4">Salud integral</h3>
                    <h4 class="text-xl font-semibold text-gray-800 mb-4 border-b-2 border-[#6B8E23] pb-2">Generales</h4>
                    <div id="generales-accordion" class="space-y-2"></div>
                    <h4 class="text-xl font-semibold text-gray-800 mt-8 mb-4 border-b-2 border-[#6B8E23] pb-2">Obstétricas</h4>
                    <div id="obstetricas-accordion" class="space-y-2"></div>
                    <h4 class="text-xl font-semibold text-gray-800 mt-8 mb-4 border-b-2 border-[#6B8E23] pb-2">Pediátricas</h4>
                    <div id="pediatricas-accordion" class="space-y-2"></div>
                </div>

                <!-- SALUD MENTAL -->
                <div>
                    <h3 class="text-2xl font-bold text-gray-900 mt-10 mb-4 pt-6 border-t">Salud mental</h3>
                    <h4 class="text-xl font-semibold text-gray-800 mb-4 border-b-2 border-[#6B8E23] pb-2">Cuestionarios psicométricos</h4>
                    <div id="salud-mental-accordion" class="space-y-2"></div>
                </div>

                <!-- DOSIS DE MEDICAMENTOS -->
                <div>
                    <h3 class="text-2xl font-bold text-gray-900 mt-10 mb-4 pt-6 border-t">Dosis de medicamentos</h3>
                    <h4 class="text-xl font-semibold text-gray-800 mb-4 border-b-2 border-[#6B8E23] pb-2">Conceptos clave</h4>
                    <div id="dosis-accordion" class="space-y-2"></div>
                </div>
            </div>
        </section>

        <!-- ===== SECCIÓN: CALCULADORA DE SALUD INTEGRAL ===== -->
        <section id="calculadora-section" class="page-section hidden">
            <div class="w-full bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-12 mb-8 printable-content">
                <!-- Título -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-[#6B8E23]">Calculadora de salud integral</h2>
                    <p class="text-lg text-gray-600 mt-2">Evalúa tus indicadores de salud física.</p>
                </div>
                <!-- Selector de Calculadora -->
                <div class="flex justify-center mb-8 no-print">
                    <div class="flex rounded-md shadow-sm w-full max-w-sm mx-auto">
                        <button id="show-adults-btn" class="flex-1 px-4 py-2 text-sm font-medium transition-colors duration-200 border border-gray-200 rounded-l-lg">
                            Adultos
                        </button>
                        <button id="show-pediatric-btn" class="flex-1 px-4 py-2 text-sm font-medium transition-colors duration-200 border-t border-b border-r border-gray-200 rounded-r-lg">
                            Pediátricos
                        </button>
                    </div>
                </div>

                <!-- ===== CALCULADORA DE ADULTOS ===== -->
                <div id="adults-calculator">
                     <section id="disclaimer-intro" class="bg-[#F7F9F4] border-l-4 border-[#6B8E23] text-[#41521C] p-4 rounded-lg mb-8 no-print">
                         <div class="ml-3">
                             <h3 class="text-base font-bold mb-1">Nota importante</h3>
                             <p class="text-sm">Si no tienes todos los datos, puedes usar los que tengas. Sin embargo, se sugiere utilizar todos los datos posibles para obtener una aproximación más precisa.</p>
                         </div>
                     </section>

                    <section id="inputs" class="mb-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 no-print">
                        <h2 class="col-span-1 md:col-span-2 lg:col-span-3 text-2xl font-semibold text-gray-800 mb-2 text-center">Tus datos personales</h2>
                        <div class="input-group"><label for="altura">Altura (cm)</label><input type="number" id="altura" placeholder="Ej: 175"></div>
                        <div class="input-group"><label for="peso">Peso actual (kg)</label><input type="number" id="peso" placeholder="Ej: 70"></div>
                        <div class="input-group"><label for="edad">Edad</label><input type="number" id="edad" placeholder="Ej: 30"></div>
                        <div class="input-group"><label for="sexo">Sexo</label><select id="sexo"><option value="hombre">Hombre</option><option value="mujer">Mujer</option></select></div>
                        <div class="input-group flex items-center"><input type="checkbox" id="diabetes" class="rounded text-[#6B8E23] focus:ring-[#6B8E23]"><label for="diabetes" class="ml-2 text-base font-bold text-gray-700">¿Tienes diabetes?</label></div>
                        <div id="embarazada-option" class="input-group flex items-center hidden"><input type="checkbox" id="embarazada" class="rounded text-[#6B8E23] focus:ring-[#6B8E23]"><label for="embarazada" class="ml-2 text-base font-bold text-gray-700">¿Estás embarazada?</label></div>
                        
                        <div class="input-group"><label for="bienestar-emocional">Bienestar emocional (1-10)</label><select id="bienestar-emocional"><option value="" disabled selected>Selecciona</option><option value="1">1 - Muy bajo</option><option value="2">2 - Bajo</option><option value="3">3 - Regular</option><option value="4">4 - Aceptable</option><option value="5">5 - Medio</option><option value="6">6 - Bueno</option><option value="7">7 - Muy bueno</option><option value="8">8 - Excelente</option><option value="9">9 - Fantástico</option><option value="10">10 - Pleno</option></select></div>
                        <div class="input-group"><label for="emocion-principal">Emoción principal</label><input type="text" id="emocion-principal" placeholder="Ej: Alegría, Estrés"></div>
                        <div class="input-group"><label for="horas-sueno">Horas de sueño</label><input type="number" id="horas-sueno" placeholder="Ej: 7"></div>
                        <div class="input-group"><label for="despierta-noche">¿Se despierta en la noche?</label><select id="despierta-noche"><option value="no">No</option><option value="si">Sí</option></select></div>
                        <div id="despierta-noche-detalles" class="hidden col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6"><div class="input-group"><label for="veces-despierta">¿Cuántas veces?</label><input type="number" id="veces-despierta" placeholder="Ej: 2"></div><div class="input-group"><label for="porque-despierta">¿Por qué? (opcional)</label><input type="text" id="porque-despierta" placeholder="Ej: Ruido, ir al baño"></div></div>
                        <div class="input-group"><label for="somnolencia-diurna">Somnolencia durante el día</label><select id="somnolencia-diurna"><option value="nunca">Nunca</option><option value="a_veces">A veces</option><option value="frecuentemente">Frecuentemente</option></select></div>

                        <div id="pregnancy-inputs" class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                            <h3 class="col-span-full text-xl font-semibold text-gray-800 mt-4 -mb-2">Datos obstétricos</h3>
                            <div class="input-group"><label for="pre-pregnancy-weight">Peso antes del embarazo (kg)</label><input type="number" id="pre-pregnancy-weight" placeholder="Ej: 65"></div>
                            <div class="input-group"><label for="lmp-date">Fecha de última menstruación</label><input type="date" id="lmp-date"></div>
                            <div class="input-group"><label for="vbac-parto-vaginal-previo">¿Parto vaginal previo?</label><input type="checkbox" id="vbac-parto-vaginal-previo" class="rounded text-[#6B8E23] focus:ring-[#6B8E23]"></div>
                            <h4 class="col-span-full text-lg font-semibold text-gray-700 mt-2">Biometría fetal (ultrasonido)</h4>
                            <div class="input-group"><label for="fetal-dbp">Diámetro biparietal (DBP, mm)</label><input type="number" id="fetal-dbp" placeholder="Ej: 80"></div>
                            <div class="input-group"><label for="fetal-cc">Circunferencia cefálica (CC, mm)</label><input type="number" id="fetal-cc" placeholder="Ej: 300"></div>
                            <div class="input-group"><label for="fetal-ca">Circunferencia abdominal (CA, mm)</label><input type="number" id="fetal-ca" placeholder="Ej: 280"></div>
                            <div class="input-group"><label for="fetal-lf">Longitud del fémur (LF, mm)</label><input type="number" id="fetal-lf" placeholder="Ej: 60"></div>
                            <h4 class="col-span-full text-lg font-semibold text-gray-700 mt-2">Puntuación de Bishop</h4>
                            <div class="input-group"><label for="bishop-dilatacion">Dilatación (cm)</label><select id="bishop-dilatacion"><option value="0">0</option><option value="1">1-2</option><option value="2">3-4</option><option value="3">>=5</option></select></div>
                            <div class="input-group"><label for="bishop-borramiento">Borramiento (%)</label><select id="bishop-borramiento"><option value="0">0-30</option><option value="1">40-50</option><option value="2">60-70</option><option value="3">>=80</option></select></div>
                            <div class="input-group"><label for="bishop-consistencia">Consistencia</label><select id="bishop-consistencia"><option value="0">Firme</option><option value="1">Media</option><option value="2">Blanda</option></select></div>
                            <div class="input-group"><label for="bishop-posicion">Posición</label><select id="bishop-posicion"><option value="0">Posterior</option><option value="1">Media</option><option value="2">Anterior</option></select></div>
                            <div class="input-group"><label for="bishop-estacion">Estación fetal</label><select id="bishop-estacion"><option value="0">-3</option><option value="1">-2</option><option value="2">-1, 0</option><option value="3">+1, +2</option></select></div>
                        </div>

                        <div id="general-inputs" class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="input-group"><label for="cintura">Cintura (cm)</label><input type="number" id="cintura" placeholder="Ej: 85"></div>
                            <div class="input-group"><label for="cadera">Cadera (cm)</label><input type="number" id="cadera" placeholder="Ej: 95"></div>
                            <div class="input-group"><label for="cuello">Cuello (cm)</label><input type="number" id="cuello" placeholder="Ej: 38"></div>
                            <div class="input-group"><label for="trigliceridos">Triglicéridos (mg/dL)</label><input type="number" id="trigliceridos" placeholder="Ej: 150"></div>
                            <div class="input-group"><label for="hdl">Colesterol HDL (mg/dL)</label><input type="number" id="hdl" placeholder="Ej: 45"></div>
                            <div class="input-group"><label for="colesterolTotal">Colesterol total (mg/dL)</label><input type="number" id="colesterolTotal" placeholder="Ej: 180"></div>
                            <div class="input-group"><label for="creatinina">Creatinina (mg/dL)</label><input type="number" id="creatinina" placeholder="Ej: 0.9"></div>
                            <div class="input-group"><label for="albumina">Albúmina (mg/L)</label><input type="number" id="albumina" placeholder="Ej: 15"></div>
                            <div class="input-group"><label for="ast">AST (U/L)</label><input type="number" id="ast" placeholder="Ej: 20"></div>
                            <div class="input-group"><label for="alt">ALT (U/L)</label><input type="number" id="alt" placeholder="Ej: 25"></div>
                            <div class="input-group"><label for="glicemia">Glicemia en ayunas (mg/dL)</label><input type="number" id="glicemia" placeholder="Ej: 80"></div>
                            <div class="input-group"><label for="insulina">Insulina en ayunas (mIU/L)</label><input type="number" id="insulina" placeholder="Ej: 5"></div>
                            <div class="input-group"><label for="pas">Presión arterial sistólica (PAS, mmHg)</label><input type="number" id="pas" placeholder="Ej: 120"></div>
                            <div class="input-group"><label for="pad">Presión arterial diastólica (PAD, mmHg)</label><input type="number" id="pad" placeholder="Ej: 80"></div>
                            <div class="input-group"><label for="actividad">Nivel de actividad</label><select id="actividad"><option value="1.2">Sedentario</option><option value="1.375">Ligero (1-3 días/sem)</option><option value="1.55">Moderado (3-5 días/sem)</option><option value="1.725">Alto (6-7 días/sem)</option><option value="1.9">Muy Alto (atletas)</option></select></div>
                            <div class="input-group col-span-1 md:col-span-2 lg:col-span-3"><label for="activity-select">Añadir actividad específica (opcional)</label><p class="text-sm text-gray-600 mb-2">Selecciona una actividad para estimar las calorías quemadas por hora, basado en tu peso actual.</p><select id="activity-select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-[#6B8E23] focus:ring-[#6B8E23] p-2"></select></div>
                            <div class="input-group"><label for="anosFumando">Años fumando</label><input type="number" id="anosFumando" placeholder="Ej: 10"></div>
                            <div class="input-group"><label for="cigarrillosDiarios">Cigarrillos diarios</label><input type="number" id="cigarrillosDiarios" placeholder="Ej: 5"></div>
                        </div>
                    </section>

                    <section id="results-section" class="mb-10">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Tus indicadores de salud</h2>
                        <div id="pregnancy-explanation" class="bg-[#F7F9F4] border-l-4 border-[#6B8E23] text-[#41521C] p-4 rounded-lg mb-8 no-print hidden"><div><h3 class="text-base font-bold mb-1">Información importante sobre el embarazo</h3><p class="text-sm">Al marcar esta opción, los índices estándar como el IMC o IAC desaparecen porque no son aplicables durante el embarazo. En su lugar, se usan métricas prenatales.</p></div></div>
                        <div id="pregnancy-results" class="hidden"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Semana gestacional y FPP</h3><p id="gestational-week" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="edd-date" class="text-md text-gray-700">-</p></div><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Ganancia de peso recomendada</h3><p id="recommended-gain" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="current-gain" class="text-md text-gray-700">-</p><p id="gain-interpretation" class="text-sm text-gray-600 mt-2"></p></div><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Peso fetal estimado (Hadlock)</h3><p id="efw-value" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="efw-interpretation" class="text-md text-gray-700"></p></div><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Puntuación de Bishop</h3><p id="bishop-value" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="bishop-interpretation" class="text-md text-gray-700"></p></div><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Probabilidad de éxito de PVDC</h3><p id="vbac-value" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="vbac-interpretation" class="text-md text-gray-700"></p></div><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Análisis del sueño</h3><p id="pregnancy-sueno-value" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="pregnancy-sueno-interpretation" class="text-md text-gray-700"></p></div><div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"><h3 class="text-xl font-semibold mb-2">Bienestar emocional</h3><p id="pregnancy-bienestar-value" class="text-3xl font-bold text-[#6B8E23] mb-1">-</p><p id="pregnancy-bienestar-interpretation" class="text-md text-gray-700"></p></div></div></div>
                        <div id="general-results">
                            <div class="chart-container mb-10 no-print"><canvas id="healthChart"></canvas></div>
                            <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>
                        <div id="macronutrient-note" class="bg-[#F7F9F4] border-l-4 border-[#6B8E23] text-[#41521C] p-4 rounded-lg my-8"><h3 class="text-base font-bold mb-2">Nota sobre macronutrientes</h3><p class="text-sm">Estos rangos son un punto de partida. La distribución ideal es personal y debe ser ajustada a tus objetivos (aumento muscular, pérdida de grasa), salud metabólica y tolerancia. Consulta a un profesional para un plan adaptado a ti.</p></div>
                        <section id="action-section" class="mt-12 p-6 rounded-lg bg-[#F7F9F4] no-print"><h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Toma el control de tu salud</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-xl font-semibold mb-4 text-[#6B8E23]">Sugerencias personalizadas</h3><ul id="action-items" class="list-disc list-inside space-y-2 text-gray-700"></ul></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-xl font-semibold mb-4 text-[#6B8E23]">Notas para tu médico</h3><p class="text-sm text-gray-600 mb-3">Utiliza este espacio para anotar preguntas o síntomas que quieras discutir con tu profesional.</p><textarea id="doctor-notes" rows="6" class="w-full rounded-md border-gray-300 shadow-sm focus:border-[#6B8E23] focus:ring-[#6B8E23] p-3 text-sm" placeholder="Ej: Mi presión ha estado más alta por las mañanas..."></textarea></div></div></section>
                        <div class="text-center mt-8 no-print"><button id="copyBtn" class="bg-[#6B8E23] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#58751d] transition-colors">Copiar resultados</button><p class="text-sm text-gray-500 mt-2">Guarda una copia para monitorear tu progreso.</p></div>
                    </section>
                </div>

                <!-- ===== CALCULADORA PEDIÁTRICA ===== -->
                <div id="pediatric-calculator" class="hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Datos del paciente pediátrico</h2>
                    <section class="mb-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 no-print">
                         <div class="input-group"><label for="pediatric-edad-meses">Edad (meses)</label><input type="number" id="pediatric-edad-meses" placeholder="Ej: 12"></div>
                        <div class="input-group"><label for="pediatric-peso">Peso (kg)</label><input type="number" id="pediatric-peso" placeholder="Ej: 9.5"></div>
                        <div class="input-group"><label for="pediatric-altura">Altura (cm)</label><input type="number" id="pediatric-altura" placeholder="Ej: 75"></div>
                        <div class="input-group"><label for="pediatric-sexo">Sexo</label><select id="pediatric-sexo"><option value="niño">Niño</option><option value="niña">Niña</option></select></div>
                        <div class="input-group"><label for="pliegue-triceps">Pliegue tricipital (mm)</label><input type="number" id="pliegue-triceps" placeholder="Ej: 8"></div>
                        <div class="input-group"><label for="pliegue-subescapular">Pliegue subescapular (mm)</label><input type="number" id="pliegue-subescapular" placeholder="Ej: 6"></div>
                    </section>
                    <section>
                         <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Resultados pediátricos</h2>
                         <div id="pediatric-results-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         </div>
                    </section>
                    <section id="pediatric-action-section" class="mt-12 p-6 rounded-lg bg-[#F7F9F4] no-print">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Pasos a seguir</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h3 class="text-xl font-semibold mb-4 text-[#6B8E23]">Sugerencias</h3>
                                <ul id="pediatric-action-items" class="list-disc list-inside space-y-2 text-gray-700">
                                </ul>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h3 class="text-xl font-semibold mb-4 text-[#6B8E23]">Notas para el pediatra</h3>
                                <p class="text-sm text-gray-600 mb-3">Anota aquí preguntas o datos para la próxima consulta.</p>
                                <textarea id="pediatric-doctor-notes" rows="6" class="w-full rounded-md border-gray-300 shadow-sm focus:border-[#6B8E23] focus:ring-[#6B8E23] p-3 text-sm" placeholder="Ej: Preguntar sobre la curva de crecimiento..."></textarea>
                            </div>
                        </div>
                    </section>
                    <div class="text-center mt-8 no-print">
                        <button id="pediatric-copyBtn" class="bg-[#6B8E23] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#58751d] transition-colors">Copiar resultados</button>
                        <p class="text-sm text-gray-500 mt-2">Guarda una copia para monitorear el progreso.</p>
                    </div>
                </div>
                
            </div>
        </section>

        <!-- ===== SECCIÓN: CALCULADORA DE SALUD MENTAL ===== -->
        <section id="mental-health-section" class="page-section hidden">
             <div class="w-full bg-white rounded-xl shadow-lg p-6 sm:p-8 lg:p-12 mb-8 printable-content">
                 <div id="mh-calculator-container">
                    
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-[#6B8E23]">Autoevaluación de bienestar emocional</h2>
                        <p class="text-lg text-gray-600 mt-2">Un espacio seguro para explorar tu salud mental.</p>
                    </div>

                      <!-- Progress Bar -->
                      <div class="mb-8 no-print">
                          <div class="flex justify-between mb-2">
                              <span id="mh-progress-text" class="text-base font-medium text-[#6B8E23]">Paso 1 de 4</span>
                              <span id="mh-progress-percent" class="text-sm font-medium text-[#6B8E23]">0%</span>
                          </div>
                          <div class="w-full bg-gray-200 rounded-full h-2.5">
                              <div id="mh-progress-bar" class="mh-progress-bar-bg h-2.5 rounded-full" style="width: 0%"></div>
                          </div>
                      </div>

                      <!-- Contador de Preguntas para feedback del usuario -->
                      <div id="mh-question-counter-wrapper" class="text-center mb-6 hidden">
                          <p id="mh-question-counter" class="text-lg text-gray-700"></p>
                      </div>

                      <!-- Step 1: Intro y Consentimiento -->
                      <div id="mh-step-1" class="mh-step">
                          <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Bienvenida</h2>
                          <p class="text-lg text-gray-700 mb-6 text-center max-w-3xl mx-auto">Esta herramienta está diseñada para ofrecer una visión integral y confidencial de tu bienestar emocional. No es un diagnóstico, sino un punto de partida para una conversación informada con un profesional de la salud mental.</p>
                          <div class="bg-[#F7F9F4] border-l-4 border-[#6B8E23] text-[#41521C] p-6 rounded-lg max-w-3xl mx-auto">
                              <h3 class="text-xl font-bold mb-3">Consentimiento informado y privacidad</h3>
                              <p class="mb-4">Tus respuestas son sensibles y serán tratadas con la máxima confidencialidad. Al continuar, aceptas que esta herramienta es un recurso de autoevaluación y no reemplaza la consulta profesional.</p>
                              <label for="mh-consent" class="flex items-center cursor-pointer">
                                  <input type="checkbox" id="mh-consent" class="h-5 w-5 rounded text-[#6B8E23] focus:ring-[#6B8E23] border-gray-300">
                                  <span class="ml-3 text-gray-800 font-medium">Entiendo y acepto continuar con la evaluación.</span>
                              </label>
                          </div>
                      </div>

                      <!-- Step 2: Marco Fundacional (MEJORADO) -->
                     <div id="mh-step-2" class="mh-step hidden">
                         <h2 class="text-2xl font-bold text-center text-[#6B8E23] mb-6">Comprendiendo tu contexto</h2>
                         <p class="text-center text-gray-600 mb-8 -mt-4 max-w-3xl mx-auto">Responder estas preguntas opcionales nos ayuda a entender mejor tu situación. Esta información es confidencial y solo para ti.</p>
                         <div class="grid grid-cols-1 gap-8 max-w-4xl mx-auto">
                             <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col">
                                 <div class="flex items-center mb-6">
                                     <h3 class="text-xl font-semibold text-gray-800">Historial y antecedentes</h3>
                                 </div>
                                 <div class="space-y-6 flex flex-col">
                                     <div class="input-group">
                                         <label for="mh-history-family">Antecedentes familiares</label>
                                         <p class="text-sm text-gray-500 mb-2">¿Alguien en tu familia cercana ha tenido condiciones de salud mental? <span class="font-normal text-gray-500">(Opcional)</span></p>
                                         <textarea id="mh-history-family" rows="3" class="bg-gray-50" placeholder="Ej: Mi madre tuvo depresión, mi abuelo ansiedad..."></textarea>
                                     </div>
                                     <div class="input-group">
                                         <label for="mh-history-personal">Tu historial personal</label>
                                         <p class="text-sm text-gray-500 mb-2">¿Has recibido algún tratamiento o diagnóstico de salud mental anteriormente? <span class="font-normal text-gray-500">(Opcional)</span></p>
                                         <textarea id="mh-history-personal" rows="3" class="bg-gray-50" placeholder="Ej: Fui a terapia por ansiedad hace dos años..."></textarea>
                                     </div>
                                 </div>
                             </div>
                             <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col">
                                 <div class="flex items-center mb-6">
                                     <h3 class="text-xl font-semibold text-gray-800">Análisis de la situación actual</h3>
                                 </div>
                                 <div class="space-y-6 flex flex-col">
                                     <div class="input-group"><label for="mh-precipitants">Desencadenantes (factores precipitantes)</label><p class="text-sm text-gray-500 mb-2">¿Qué evento o situación crees que desencadenó o empeoró tu malestar actual?</p><textarea id="mh-precipitants" rows="3" class="bg-gray-50" placeholder="Ej: La pérdida de mi trabajo, una ruptura..."></textarea></div>
                                     <div class="input-group"><label for="mh-perpetuators">Mantenedores (factores perpetuadores)</label><p class="text-sm text-gray-500 mb-2">¿Qué cosas sientes que mantienen o agravan el problema en tu día a día?</p><textarea id="mh-perpetuators" rows="3" class="bg-gray-50" placeholder="Ej: El aislamiento social, dormir mal..."></textarea></div>
                                     <div class="input-group"><label for="mh-protectives">Apoyos (factores protectores)</label><p class="text-sm text-gray-500 mb-2">¿Qué o quién te ayuda a sentirte mejor, incluso por un momento?</p><textarea id="mh-protectives" rows="3" class="bg-gray-50" placeholder="Ej: Hablar con un amigo, hacer ejercicio..."></textarea></div>
                                     <div class="input-group"><label for="mh-trauma-trigger">Experiencias traumáticas</label><p class="text-sm text-gray-500 mb-2">¿Alguna vez has experimentado un evento profundamente angustiante o que amenazó tu vida?</p><select id="mh-trauma-trigger"><option value="no">No</option><option value="si">Sí</option></select></div>
                                 </div>
                             </div>
                         </div>
                     </div>
                      
                      <!-- Step 3: Cuestionarios (REDISENADO) -->
                     <div id="mh-step-3" class="mh-step hidden">
                          <h2 class="text-2xl font-bold text-center text-[#6B8E23] mb-8">Indicadores centrales de bienestar</h2>
                          <div id="mh-questionnaires-container" class="space-y-8">
                              <!-- Los cuestionarios rediseñados se inyectarán aquí -->
                          </div>
                     </div>

                      <!-- Step 4: Resultados -->
                      <div id="mh-step-4" class="mh-step hidden">
                          <h2 class="text-3xl font-bold text-center text-[#6B8E23] mb-6">Tu perfil de salud mental</h2>
                          <div id="mh-results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Las tarjetas de resultados se inyectarán aquí -->
                          </div>
                          <section id="mh-action-section" class="mt-12 p-6 rounded-lg bg-[#F7F9F4] no-print">
                              <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Pasos a seguir y reflexiones</h2>
                              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                  <div class="bg-white p-6 rounded-lg shadow-sm">
                                      <h3 class="text-xl font-semibold mb-4 text-[#6B8E23]">Sugerencias de rutas de atención</h3>
                                      <ul id="mh-action-items" class="list-disc list-inside space-y-3 text-gray-700"></ul>
                                  </div>
                                  <div class="bg-white p-6 rounded-lg shadow-sm">
                                      <h3 class="text-xl font-semibold mb-4 text-[#6B8E23]">Notas para tu profesional de salud mental</h3>
                                      <p class="text-sm text-gray-600 mb-3">Este es un espacio confidencial para ti. Anota cualquier pensamiento, pregunta o tema que quieras recordar discutir en tu próxima consulta.</p>
                                      <textarea id="mh-professional-notes" rows="6" class="w-full rounded-md border-gray-300 shadow-sm focus:border-[#6B8E23] focus:ring-[#6B8E23] p-3 text-sm" placeholder="Ej: Me sentí particularmente ansioso/a después de [evento específico]... Quiero preguntar sobre técnicas para manejar [síntoma]..."></textarea>
                                  </div>
                              </div>
                          </section>
                          <div class="text-center mt-8 no-print">
                              <button id="mh-copyBtn" class="bg-[#6B8E23] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#58751d] transition-colors">Copiar resultados</button>
                              <p class="text-sm text-gray-500 mt-2">Guarda una copia para tu registro personal o para compartirla con tu profesional.</p>
                          </div>
                      </div>
                      
                      <!-- Botones de Navegación -->
                      <div class="mt-10 flex justify-between no-print">
                          <button id="mh-prev-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors hidden">Anterior</button>
                          <button id="mh-next-btn" class="bg-[#6B8E23] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#58751d] transition-colors ml-auto disabled:opacity-50 disabled:cursor-not-allowed" disabled>Siguiente</button>
                      </div>
                 </div>
             </div>
        </section>

        <!-- ===== SECCIÓN: CALCULADORA DE DOSIS ===== -->
        <section id="dosis-section" class="page-section hidden">
             <div class="w-full bg-white rounded-xl shadow-lg p-4 sm:p-8 md:p-12 mb-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-[#6B8E23]">Calculadora de dosis de medicamentos</h2>
                    <p class="text-lg text-gray-600 mt-2">Encuentra la dosis adecuada según la prescripción y la presentación del medicamento.</p>
                </div>

                 <div class="flex flex-col md:flex-row justify-end items-center mb-8 gap-4">
                    <button id="open-meds-list-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 transition-colors w-full md:w-auto">
                        Lista de medicamentos
                    </button>
                 </div>

                 <div class="space-y-8">
                     <!-- Grupo 1: Datos de la Prescripción -->
                     <div>
                         <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">1. Datos de la prescripción</h3>
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                             <div class="input-group">
                                 <label for="dosis-peso-new">Peso (kg)</label>
                                 <input type="number" id="dosis-peso-new" placeholder="15">
                             </div>
                              <div class="input-group">
                                 <label for="dosis-posologia-new">Posología (mg/kg/día)</label>
                                 <input type="number" id="dosis-posologia-new" placeholder="30">
                             </div>
                             <div class="input-group">
                                 <label for="dosis-frecuencia-new">A repartir en</label>
                                 <select id="dosis-frecuencia-new">
                                     <option value="1">1 dosis = cada 24 horas</option>
                                     <option value="2">2 dosis = cada 12 horas</option>
                                     <option value="3" selected>3 dosis = cada 8 horas</option>
                                     <option value="4">4 dosis = cada 6 horas</option>
                                     <option value="6">6 dosis = cada 4 horas</option>
                                 </select>
                             </div>
                         </div>
                         <div id="fixed-dose-note" class="hidden bg-[#F7F9F4] border-l-4 border-[#6B8E23] text-[#41521C] p-3 rounded-lg mt-2">
                             <p class="text-sm">Este medicamento funciona con dosis fijas (no por peso). La posología se ha establecido en 0. Por favor, verifique el prospecto para la dosis correcta según la edad o condición.</p>
                         </div>
                     </div>
                     
                     <!-- Grupo 2: Datos del Medicamento -->
                     <div>
                         <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">2. Datos del medicamento</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                              <div class="input-group">
                                 <label for="dosis-presentacion-new">Presentación</label>
                                 <select id="dosis-presentacion-new">
                                     <option value="solucion">Solución / Suspensión</option>
                                     <option value="gotas">Gotas</option>
                                     <option value="comprimidos">Comprimidos</option>
                                     <option value="sobres">Sobres</option>
                                     <option value="supositorios">Supositorios</option>
                                     <option value="inyectables">Inyectables</option>
                                 </select>
                             </div>
                             <!-- Conditional Fields -->
                             <div id="dosis-field-liquido-new" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6">
                                 <div class="input-group">
                                     <label for="dosis-concentracion-mg-new">Nº de mg</label>
                                     <input type="number" id="dosis-concentracion-mg-new" placeholder="100">
                                 </div>
                                 <div class="input-group">
                                     <label for="dosis-concentracion-ml-new">Nº de ml</label>
                                     <input type="number" id="dosis-concentracion-ml-new" placeholder="5">
                                 </div>
                             </div>
                             <div id="dosis-field-solido-new" class="input-group hidden">
                                 <label for="dosis-mg-unidad-new">mg por unidad</label>
                                 <input type="number" id="dosis-mg-unidad-new" placeholder="250">
                             </div>
                         </div>
                     </div>

                     <!-- Grupo 3: Resultados -->
                      <div>
                         <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">3. Resultados del cálculo</h3>
                         <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-6">
                              <div class="bg-[#F7F9F4] p-6 rounded-lg shadow-inner text-center">
                                 <h4 class="text-lg font-semibold text-gray-700 mb-2">Dosis diaria total</h4>
                                 <p id="dosis-dia-result-new" class="text-3xl font-bold text-[#6B8E23] break-words">-</p>
                             </div>
                              <div class="bg-[#F7F9F4] p-6 rounded-lg shadow-inner text-center">
                                 <h4 class="text-lg font-semibold text-gray-700 mb-2">Dosis por toma</h4>
                                 <p id="dosis-toma-result-new" class="text-3xl font-bold text-[#6B8E23] break-words">-</p>
                             </div>
                         </div>
                     </div>

                     <!-- Utilidad Adicional -->
                     <div class="pt-6 mt-6 border-t">
                         <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="font-semibold text-gray-800 mb-4 text-center">Utilidad adicional: Calcular concentración (mg/ml)</h3>
                             <div class="max-w-2xl mx-auto flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                                 <!-- Inputs container -->
                                 <div class="flex-grow flex flex-col sm:flex-row items-end gap-4">
                                     <div class="input-group mb-0 w-full sm:w-auto flex-1">
                                         <label for="dosis-util-mg-new" class="text-sm">Nº de mg</label>
                                         <input type="number" id="dosis-util-mg-new" placeholder="250">
                                     </div>
                                     <div class="input-group mb-0 w-full sm:w-auto flex-1">
                                         <label for="dosis-util-ml-new" class="text-sm">Nº de ml</label>
                                         <input type="number" id="dosis-util-ml-new" placeholder="5">
                                     </div>
                                 </div>
                                 <!-- Result container -->
                                 <div class="w-full md:w-auto text-center md:text-left pt-2 md:pt-0">
                                      <p class="text-lg font-bold text-[#6B8E23]" id="dosis-mgml-result-new">Resultado: - mg/ml</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- Botón de Copiar Resultados -->
                 <div class="text-center mt-8 no-print">
                     <button id="dosis-copyBtn" class="bg-[#6B8E23] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#58751d] transition-colors">Copiar resultados</button>
                     <p class="text-sm text-gray-500 mt-2">Guarda una copia para tus registros o para compartir.</p>
                 </div>

                 <!-- Disclaimer -->
                 <div class="mt-10 bg-[#F7F9F4] border-l-4 border-[#6B8E23] text-[#41521C] p-4 rounded-lg no-print">
                     <p class="text-sm">
                         Los resultados ofrecidos representan una aproximación general confiable, aunque su aplicabilidad individual puede variar. Por ello, se recomienda que un profesional calificado evalúe y supervise su interpretación en cada caso particular.
                     </p>
                 </div>
             </div>
        </section>

    </main>
    
    <!-- ===== Modal Farmacológico ===== -->
    <div id="meds-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 no-print">
        <div id="meds-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <!-- Scrollable Area -->
            <div class="overflow-y-auto">
                <!-- Header -->
                <div class="flex justify-between items-center p-4 border-b bg-white rounded-t-xl">
                    <h3 class="text-2xl font-bold text-[#6B8E23]">Lista de medicamentos</h3>
                    <button id="close-meds-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <!-- Disclaimer -->
                <div class="p-4 bg-[#F7F9F4] border-b border-gray-200">
                    <h4 class="font-bold text-[#556B2F]">Aviso importante</h4>
                    <p class="text-sm text-[#41521C] mt-1">
                        Esta calculadora es una herramienta de orientación y no sustituye en ningún caso el diagnóstico, la prescripción o el consejo profesional de un médico o farmacéutico. La información proporcionada se basa en dosis estándar para medicamentos de venta libre. No utilice esta herramienta para tomar decisiones médicas. Antes de administrar cualquier medicamento, lea detenidamente el prospecto y consulte a un profesional de la salud, especialmente si está embarazada, en período de lactancia, padece alguna enfermedad crónica o está tomando otros medicamentos. El creador de esta herramienta no se hace responsable del uso indebido de la información aquí presentada.
                    </p>
                </div>
                <!-- Content -->
                <div id="meds-list-container" class="p-4">
                    <!-- Las categorías y medicamentos se inyectarán aquí -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== FOOTER FIJO ===== -->
    <footer class="fixed bottom-0 left-0 w-full bg-[#FDFBF6] p-3 border-t border-gray-200 no-print z-40 text-center text-xs text-gray-600 shadow-[0_-2px_5px_rgba(0,0,0,0.05)]">
        <p class="mb-1"><strong>Descargo de responsabilidad:</strong> Esta es una herramienta educativa y no sustituye la consulta médica profesional.</p>
        <p>&copy; <span id="year">2025</span> Calculadora de Salud Integral. Todos los derechos reservados.</p>
    </footer>

    <div id="toast" class="opacity-0 no-print"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const navLinks = document.querySelectorAll('.nav-link');
        const pageSections = document.querySelectorAll('.page-section');
        const menuButton = document.getElementById('menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuOpenIcon = document.getElementById('menu-open-icon');
        const menuCloseIcon = document.getElementById('menu-close-icon');
        const showAdultsBtn = document.getElementById('show-adults-btn');
        const showPediatricBtn = document.getElementById('show-pediatric-btn');
        const adultsCalculator = document.getElementById('adults-calculator');
        const pediatricCalculator = document.getElementById('pediatric-calculator');
        const pediatricActionItemsList = document.getElementById('pediatric-action-items');
        const pediatricCopyBtn = document.getElementById('pediatric-copyBtn');
        
        const inputElements = {
            altura: document.getElementById('altura'), peso: document.getElementById('peso'), edad: document.getElementById('edad'), sexo: document.getElementById('sexo'), cintura: document.getElementById('cintura'), cadera: document.getElementById('cadera'), cuello: document.getElementById('cuello'), trigliceridos: document.getElementById('trigliceridos'), hdl: document.getElementById('hdl'), colesterolTotal: document.getElementById('colesterolTotal'), glicemia: document.getElementById('glicemia'), insulina: document.getElementById('insulina'), pas: document.getElementById('pas'), pad: document.getElementById('pad'), creatinina: document.getElementById('creatinina'), albumina: document.getElementById('albumina'), ast: document.getElementById('ast'), alt: document.getElementById('alt'), actividad: document.getElementById('actividad'), anosFumando: document.getElementById('anosFumando'), cigarrillosDiarios: document.getElementById('cigarrillosDiarios'), diabetes: document.getElementById('diabetes'), embarazada: document.getElementById('embarazada'), prePregnancyWeight: document.getElementById('pre-pregnancy-weight'), lmpDate: document.getElementById('lmp-date'), fetalDbp: document.getElementById('fetal-dbp'), fetalCc: document.getElementById('fetal-cc'), fetalCa: document.getElementById('fetal-ca'), fetalLf: document.getElementById('fetal-lf'), bishopDilatacion: document.getElementById('bishop-dilatacion'), bishopBorramiento: document.getElementById('bishop-borramiento'), bishopConsistencia: document.getElementById('bishop-consistencia'), bishopPosicion: document.getElementById('bishop-posicion'), bishopEstacion: document.getElementById('bishop-estacion'), vbacPartoVaginalPrevio: document.getElementById('vbac-parto-vaginal-previo'), pediatricEdadMeses: document.getElementById('pediatric-edad-meses'), pediatricPeso: document.getElementById('pediatric-peso'), pediatricAltura: document.getElementById('pediatric-altura'), pediatricSexo: document.getElementById('pediatric-sexo'), pliegueTriceps: document.getElementById('pliegue-triceps'), pliegueSubescapular: document.getElementById('pliegue-subescapular'), bienestarEmocional: document.getElementById('bienestar-emocional'), emocionPrincipal: document.getElementById('emocion-principal'), horasSueno: document.getElementById('horas-sueno'), despiertaNoche: document.getElementById('despierta-noche'), vecesDespierta: document.getElementById('veces-despierta'), porqueDespierta: document.getElementById('porque-despierta'), somnolenciaDiurna: document.getElementById('somnolencia-diurna'), activitySelect: document.getElementById('activity-select')
        };
        const generalInputsSection = document.getElementById('general-inputs');
        const pregnancyInputsSection = document.getElementById('pregnancy-inputs');
        const generalResultsSection = document.getElementById('general-results');
        const pregnancyResultsSection = document.getElementById('pregnancy-results');
        const pregnancyExplanationSection = document.getElementById('pregnancy-explanation');
        const embarazadaOption = document.getElementById('embarazada-option');
        const despiertaNocheDetalles = document.getElementById('despierta-noche-detalles');
        const actionItemsList = document.getElementById('action-items');
        const copyBtn = document.getElementById('copyBtn');
        const macronutrientNote = document.getElementById('macronutrient-note');
        let healthChart;
        let currentResults = {};
        let currentPediatricResults = {};

        const metricas = {
            generales: [
                { id: 'imc', title: 'IMC (Índice de masa corporal)', desc: 'Una relación entre tu peso y altura.', detail: 'Calculado como peso(kg)/altura(m)². Es un indicador de primer nivel para el cribado de categorías de peso que pueden llevar a problemas de salud. No distingue entre masa grasa y masa magra.' },
                { id: 'iac', title: 'IAC (Índice de adiposidad corporal)', desc: 'Estima el porcentaje de grasa corporal.', detail: 'Utiliza la fórmula [(cadera(cm) / altura(m)^1.5) - 18]. A diferencia del IMC, intenta estimar directamente la grasa corporal, siendo útil en estudios poblacionales, aunque puede ser menos preciso individualmente.' },
                { id: 'absi', title: 'ABSI (Índice de forma corporal)', desc: 'Relaciona cintura, altura e IMC para el riesgo.', detail: 'Incorpora la circunferencia de la cintura, un indicador de adiposidad central. Se ha propuesto como un predictor de mortalidad con mayor especificidad que el IMC, especialmente en lo que respecta al riesgo asociado a la grasa visceral.' },
                { id: 'bri', title: 'BRI (Índice de redondez corporal)', desc: 'Evalúa la forma del cuerpo y la grasa visceral.', detail: 'Es un índice más complejo que modela la forma del cuerpo como una elipse. Valores más altos se correlacionan fuertemente con la cantidad de tejido adiposo visceral, un factor de riesgo cardiometabólico clave.' },
                { id: 'vai', title: 'VAI (Índice de adiposidad visceral)', desc: 'Estima la función de la grasa visceral.', detail: 'Combina parámetros antropométricos (IMC, circunferencia de cintura) y metabólicos (triglicéridos, colesterol HDL) para funcionar como un marcador sustituto de la disfunción del tejido adiposo y el riesgo cardiometabólico.' },
                { id: 'grasa-corporal', title: 'Grasa corporal (%)', desc: 'Porcentaje de grasa corporal estimado.', detail: 'Calculado mediante el método de la Marina de EE. UU., que utiliza mediciones de cuello, cintura y altura (y cadera en mujeres). Ofrece una estimación de la composición corporal, aunque su precisión puede variar según la población.' },
                { id: 'ffmi', title: 'FFMI (Índice de masa libre de grasa)', desc: 'Estima la cantidad de masa muscular.', detail: 'Calculado como [peso(kg) * (1 - %grasa corporal)] / altura(m)². Es útil para evaluar la masa muscular en relación con la estatura, especialmente en atletas. Rangos normalizados suelen ser 18-22 para hombres y 14-18 para mujeres.' },
                { id: 'peso-ideal', title: 'Peso ideal y ajustado', desc: 'Estimaciones de peso ideal y ajustado.', detail: 'El peso ideal se calcula con la fórmula de Devine como referencia teórica. El peso ajustado se utiliza en farmacocinética para dosificar medicamentos en pacientes con obesidad, promediando el exceso de peso.' },
                { id: 'distribucion', title: 'Índices de distribución (ICC, ICA)', desc: 'Índice cintura-cadera e índice cintura-altura.', detail: 'Ambos evalúan la adiposidad central. Un ICC > 0.90 en hombres o > 0.85 en mujeres, y un ICA > 0.5 en ambos sexos, se asocian con un riesgo cardiovascular y metabólico significativamente mayor.' },
                { id: 'tmb', title: 'Tasa metabólica basal (TMB)', desc: 'Calorías que quemas en reposo.', detail: 'Calculada con la ecuación de Mifflin-St Jeor, considerada una de las más precisas. Representa el gasto energético en reposo (REE), la energía mínima para las funciones vitales en un estado de ayuno y reposo total.' },
                { id: 'get', title: 'Gasto energético total (GET)', desc: 'Calorías totales que quemas en un día.', detail: 'Es la suma de la TMB, el efecto térmico de los alimentos y la energía gastada en la actividad física. Se estima multiplicando la TMB por un factor de nivel de actividad física (PAL).' },
                { id: 'calories-burned', title: 'Gasto por actividad física', desc: 'Estimación de calorías quemadas para una actividad específica.', detail: 'Utiliza el Equivalente Metabólico de Tarea (MET), donde 1 MET es el consumo de oxígeno en reposo. La fórmula es: (MET * 3.5 * peso en kg) / 200 * minutos.' },
                { id: 'macros', title: 'Macronutrientes', desc: 'Distribución sugerida de proteínas, grasas y carbohidratos.', detail: 'Basado en los Rangos de Distribución Aceptable de Macronutrientes (AMDR), que son rangos de ingesta asociados con la reducción del riesgo de enfermedades crónicas mientras se proporcionan nutrientes esenciales.' },
                { id: 'homa-ir', title: 'HOMA-IR', desc: 'Estimación de resistencia a la insulina.', detail: 'El Modelo de Evaluación de la Homeostasis (HOMA-IR) se calcula como [insulina ayunas (μU/mL) * glucosa ayunas (mg/dL)] / 405. Un valor > 2.5-3.0 a menudo se considera un indicador de resistencia a la insulina.' },
                { id: 'ast-alt', title: 'Relación AST/ALT', desc: 'Para evaluar la salud del hígado.', detail: 'Conocido como el cociente de De Ritis. Un cociente > 2 es altamente sugestivo de hepatopatía alcohólica, mientras que un cociente < 1 es más común en la enfermedad del hígado graso no alcohólico (NAFLD) y la hepatitis viral.' },
                { id: 'pam', title: 'Presión arterial media (PAM)', desc: 'Presión media del sistema circulatorio.', detail: 'Se calcula como PAD + 1/3(PAS - PAD). Es un indicador crucial de la perfusión de los órganos vitales. Una PAM de 65-70 mmHg es a menudo el objetivo mínimo en entornos de cuidados críticos para asegurar una perfusión adecuada.' },
                { id: 'tfge', title: 'TFG estimada (CKD-EPI)', desc: 'Tasa de filtración glomerular.', detail: 'Calculada con la fórmula CKD-EPI 2021, es el mejor indicador general de la función renal. Estima el volumen de sangre que los riñones filtran por minuto y se utiliza para estadificar la enfermedad renal crónica.' },
                { id: 'ascvd', title: 'Riesgo cardiovascular (ASCVD)', desc: 'Riesgo a 10 años de un evento cardiovascular.', detail: 'Calculado con las ecuaciones de cohorte agrupadas de la ACC/AHA. Estima el riesgo de un primer evento de enfermedad cardiovascular aterosclerótica (infarto de miocardio, ictus o muerte cardiovascular).' },
                { id: 'framingham', title: 'Riesgo cardiovascular (Framingham)', desc: 'Riesgo de evento coronario a 10 años.', detail: 'Basado en el estudio de Framingham, es un modelo clásico que predice el riesgo a 10 años de enfermedad coronaria (infarto de miocardio, angina de pecho o muerte por causa coronaria).' },
                { id: 'score', title: 'Riesgo cardiovascular (SCORE)', desc: 'Riesgo de evento fatal a 10 años (Europa).', detail: 'Desarrollado por la Sociedad Europea de Cardiología, estima el riesgo a 10 años de un primer evento cardiovascular fatal en poblaciones europeas. A diferencia de Framingham, se centra solo en la mortalidad.' },
                { id: 'castelli', title: 'Índice aterogénico (Castelli)', desc: 'Relación colesterol total / HDL.', detail: 'Un indicador simple del riesgo de aterosclerosis. Un índice < 3.5 se considera de bajo riesgo, mientras que valores > 5.0 (hombres) o > 4.5 (mujeres) indican un riesgo elevado.' },
                { id: 'ipa', title: 'IPA (Índice paquetes/año)', desc: 'Riesgo acumulado de tabaquismo.', detail: 'Cuantifica la exposición total al tabaco. Se calcula como [(nº cigarrillos/día) / 20] * años fumando. Un IPA > 20 es un factor de riesgo muy significativo para EPOC y cáncer de pulmón.' },
                { id: 'sueno', title: 'Análisis del sueño', desc: 'Resumen cualitativo de los hábitos de sueño.', detail: 'Evalúa la duración y la calidad percibida del sueño. La fragmentación del sueño y la somnolencia diurna son indicadores clave de una mala arquitectura del sueño, afectando la salud cognitiva y metabólica.' },
                { id: 'bienestar', title: 'Bienestar emocional', desc: 'Autoevaluación del estado emocional.', detail: 'Una métrica subjetiva que refleja la percepción personal del estado de ánimo y la satisfacción con la vida. La emoción predominante puede ser un indicador útil para la anamnesis.' },
            ],
            obstetricas: [
                { title: 'Semana gestacional y FPP', desc: 'Tiempo de embarazo y fecha de parto.', detail: 'La edad gestacional se calcula a partir de la fecha de última menstruación (FUM) y se confirma por ecografía. La fecha probable de parto (FPP) se estima a las 40 semanas (280 días) desde la FUM, usando la regla de Naegele.' },
                { title: 'Ganancia de peso recomendada', desc: 'Rango de aumento de peso sugerido.', detail: 'Basado en las directrices del Instituto de Medicina (IOM) de EE. UU., estratifica la ganancia de peso ideal según el IMC pregestacional para minimizar riesgos maternos y fetales.' },
                { title: 'Peso fetal estimado (Hadlock)', desc: 'Estimación del peso del feto.', detail: 'La fórmula de Hadlock es una de las más utilizadas y combina cuatro parámetros biométricos fetales (DBP, CC, CA, LF) obtenidos por ultrasonido para estimar el peso. Tiene un margen de error inherente de ±15%.' },
                { title: 'Puntuación de Bishop', desc: 'Evalúa la favorabilidad del cuello uterino para el parto.', detail: 'Un sistema de puntuación que evalúa cinco componentes cervicales (dilatación, borramiento, estación, consistencia, posición). Una puntuación ≥ 8 se asocia con una alta probabilidad de éxito en la inducción del parto.' },
                { title: 'Probabilidad de éxito de PVDC', desc: 'Probabilidad de parto vaginal después de cesárea.', detail: 'Una estimación del éxito de un parto vaginal en mujeres con una cesárea anterior. Se basa en nomogramas validados que consideran factores como edad, IMC, partos vaginales previos y motivo de la cesárea anterior.' },
            ],
            pediatricas: [
                { title: 'IMC por percentil (OMS/CDC)', desc: 'Compara el IMC con niños de misma edad y sexo.', detail: 'Utiliza las curvas de crecimiento de la OMS (para < 2 años) y de los CDC (para ≥ 2 años). Los percentiles < 5º, 85º-95º y > 95º definen bajo peso, sobrepeso y obesidad, respectivamente.' },
                { title: '% Grasa corporal (Slaughter)', desc: 'Estimación de grasa a partir de pliegues cutáneos.', detail: 'Utiliza las ecuaciones de Slaughter, que se basan en la suma de los pliegues cutáneos tricipital y subescapular para estimar el porcentaje de grasa corporal en niños y adolescentes.' },
                { title: 'Gasto energético basal (Schofield)', desc: 'Calorías mínimas necesarias en reposo.', detail: 'Las ecuaciones de Schofield estiman el gasto energético en reposo para la población pediátrica basándose en el peso, la edad y el sexo. Son una herramienta fundamental en la nutrición clínica pediátrica.' },
            ],
            saludMental: [
                { title: 'PHQ-9 (Cuestionario sobre la salud del paciente-9)', desc: 'Evalúa la presencia y severidad de síntomas depresivos.', detail: 'Es una herramienta de cribado validada para el Trastorno Depresivo Mayor que se correlaciona bien con los criterios del DSM-5. También se utiliza para monitorizar la respuesta al tratamiento.' },
                { title: 'GAD-7 (Trastorno de ansiedad generalizada-7)', desc: 'Mide la severidad de los síntomas de ansiedad generalizada.', detail: 'Una herramienta de cribado eficaz para el Trastorno de Ansiedad Generalizada (TAG) y otros trastornos de ansiedad. Una puntuación ≥ 10 tiene buena sensibilidad y especificidad para el diagnóstico de TAG.' },
                { title: 'PSS-10 (Escala de estrés percibido-10)', desc: 'Mide el grado en que las situaciones de la vida se perciben como estresantes.', detail: 'No mide la cantidad de estresores, sino la percepción subjetiva de que la vida es impredecible, incontrolable y sobrecargada. Es un buen indicador del riesgo de problemas de salud relacionados con el estrés.' },
                { title: 'RSE (Escala de autoestima de Rosenberg)', desc: 'Evalúa la autoestima global y los sentimientos de valía personal.', detail: 'Es la escala de autoestima más utilizada en investigación social y clínica. Mide la autoaceptación y el autorespeto, componentes clave del bienestar psicológico.' },
                { title: 'CD-RISC-10 (Escala de resiliencia de Connor-Davidson-10)', desc: 'Mide la capacidad de una persona para recuperarse de la adversidad.', detail: 'Evalúa la resiliencia como una medida de la capacidad para afrontar el estrés. Puntuaciones altas se asocian con una mejor adaptación a los cambios y una mayor fortaleza personal ante los desafíos.' },
                { title: 'PCL-5 (Lista de verificación de TEPT para DSM-5)', desc: 'Evalúa los síntomas del trastorno de estrés postraumático (TEPT).', detail: 'Una herramienta de autoinforme de 20 ítems que evalúa los síntomas del TEPT según los criterios del DSM-5. Una puntuación de 31-33 se sugiere a menudo como un punto de corte para una evaluación diagnóstica adicional.' },
            ],
            dosis: [
                { title: 'Posología (mg/kg/día)', desc: 'Cantidad de medicamento por peso corporal por día.', detail: 'Es la base de la dosificación ponderal, crucial en pediatría. Define la cantidad total de principio activo (mg) por kilogramo de peso del paciente a administrar en un período de 24 horas.' },
                { title: 'Presentación y concentración', desc: 'Forma y cantidad de medicamento en un volumen.', detail: 'La presentación farmacéutica (jarabe, gotas) y su concentración (ej. 100 mg / 5 ml) son vitales para la conversión de la dosis prescrita en miligramos a un volumen administrable (ml, gotas) o unidades (comprimidos).' },
                { title: 'Frecuencia (dosis por toma)', desc: 'Cómo se divide la dosis diaria.', detail: 'Determinada por la farmacocinética del medicamento, principalmente su vida media (t½). La frecuencia de dosificación (ej. cada 8 horas) tiene como objetivo mantener las concentraciones plasmáticas del fármaco dentro del rango terapéutico.' },
            ]
        };

        const activityMETs = [
            { name: "--- Reposo y actividades ligeras ---", met: 0 },
            { name: "Dormir", met: 0.9 },
            { name: "Ver televisión", met: 1.0 },
            { name: "Trabajo de oficina, sentado", met: 1.3 },
            { name: "Leer, sentado", met: 1.3 },
            { name: "Cocinar, de pie", met: 2.5 },
            { name: "--- Caminar y correr ---", met: 0 },
            { name: "Caminar, muy lento (2.5 km/h)", met: 2.0 },
            { name: "Caminar, paso moderado (4.5 km/h)", met: 3.5 },
            { name: "Caminar, paso rápido (6.5 km/h)", met: 5.0 },
            { name: "Caminar cuesta arriba", met: 6.0 },
            { name: "Senderismo", met: 6.0 },
            { name: "Trotar (8 km/h)", met: 8.0 },
            { name: "Correr (10 km/h)", met: 10.0 },
            { name: "Correr (12 km/h)", met: 12.5 },
            { name: "Correr (16 km/h)", met: 16.0 },
            { name: "Subir escaleras", met: 8.0 },
            { name: "--- Ciclismo ---", met: 0 },
            { name: "Ciclismo, ocio (<16 km/h)", met: 4.0 },
            { name: "Ciclismo, moderado (16-19 km/h)", met: 6.8 },
            { name: "Ciclismo, vigoroso (20-25 km/h)", met: 8.0 },
            { name: "Ciclismo, muy vigoroso (26-30 km/h)", met: 10.0 },
            { name: "Ciclismo, competitivo (>32 km/h)", met: 15.8 },
            { name: "Bicicleta estática, ligero", met: 5.3 },
            { name: "Bicicleta estática, vigoroso", met: 11.0 },
            { name: "BMX o ciclismo de montaña", met: 8.5 },
            { name: "--- Deportes de equipo ---", met: 0 },
            { name: "Baloncesto, partido", met: 8.0 },
            { name: "Baloncesto, lanzando a canasta", met: 4.5 },
            { name: "Baloncesto en silla de ruedas", met: 6.5 },
            { name: "Béisbol", met: 5.0 },
            { name: "Fútbol, competitivo", met: 10.0 },
            { name: "Fútbol, casual", met: 7.0 },
            { name: "Fútbol americano, competitivo", met: 8.0 },
            { name: "Hockey sobre césped", met: 7.8 },
            { name: "Hockey sobre hielo", met: 8.0 },
            { name: "Lacrosse", met: 8.0 },
            { name: "Polo acuático", met: 10.0 },
            { name: "Rugby", met: 8.3 },
            { name: "Sóftbol", met: 5.0 },
            { name: "Ultimate frisbee", met: 8.0 },
            { name: "Voleibol, partido", met: 8.0 },
            { name: "Voleibol, de playa", met: 8.0 },
            { name: "Voleibol, no competitivo", met: 4.0 },
            { name: "Balonmano", met: 12.0 },
            { name: "--- Deportes de raqueta ---", met: 0 },
            { name: "Bádminton, competitivo", met: 7.0 },
            { name: "Bádminton, social", met: 5.5 },
            { name: "Pádel", met: 6.0 },
            { name: "Raquetbol, competitivo", met: 10.0 },
            { name: "Raquetbol, casual", met: 7.0 },
            { name: "Squash", met: 12.0 },
            { name: "Tenis, individual", met: 7.3 },
            { name: "Tenis, dobles", met: 6.0 },
            { name: "Tenis de mesa", met: 4.0 },
            { name: "--- Deportes acuáticos ---", met: 0 },
            { name: "Natación, estilo crol, rápido (>68 m/min)", met: 10.0 },
            { name: "Natación, estilo crol, lento (<45 m/min)", met: 7.0 },
            { name: "Natación, estilo espalda", met: 7.0 },
            { name: "Natación, estilo braza", met: 10.0 },
            { name: "Natación, estilo mariposa", met: 11.0 },
            { name: "Nado sincronizado", met: 8.0 },
            { name: "Buceo", met: 7.0 },
            { name: "Kayak", met: 5.0 },
            { name: "Piragüismo/Remo, ocio", met: 3.5 },
            { name: "Piragüismo/Remo, competitivo (>9.7 km/h)", met: 12.0 },
            { name: "Surf", met: 5.0 },
            { name: "Vela", met: 3.0 },
            { name: "Esquí acuático", met: 6.0 },
            { name: "--- Gimnasia y danza ---", met: 0 },
            { name: "Aeróbicos, bajo impacto", met: 5.0 },
            { name: "Aeróbicos, alto impacto", met: 7.3 },
            { name: "Calistenia (ej. flexiones, abdominales), vigoroso", met: 8.0 },
            { name: "Calistenia, ligero/moderado", met: 3.8 },
            { name: "Gimnasia artística", met: 6.0 },
            { name: "Danza, ballet o moderno", met: 6.8 },
            { name: "Danza, salón, lento", met: 3.0 },
            { name: "Danza, aeróbico, zumba", met: 7.3 },
            { name: "HIIT (Entrenamiento de intervalos de alta intensidad)", met: 8.0 },
            { name: "CrossFit", met: 13.5 },
            { name: "--- Deportes de combate ---", met: 0 },
            { name: "Boxeo, en el ring", met: 12.8 },
            { name: "Boxeo, sparring", met: 9.0 },
            { name: "Esgrima", met: 6.0 },
            { name: "Judo", met: 10.3 },
            { name: "Jiu-Jitsu", met: 10.3 },
            { name: "Karate", met: 10.3 },
            { name: "Kickboxing", met: 10.3 },
            { name: "Krav Maga", met: 10.3 },
            { name: "Muay Thai", met: 10.3 },
            { name: "Lucha libre", met: 6.0 },
            { name: "Taekwondo", met: 10.3 },
            { name: "--- Deportes de invierno ---", met: 0 },
            { name: "Biatlón", met: 13.5 },
            { name: "Bobsleigh", met: 7.0 },
            { name: "Curling", met: 4.0 },
            { name: "Patinaje artístico", met: 7.0 },
            { name: "Patinaje sobre hielo, general", met: 7.0 },
            { name: "Patinaje de velocidad", met: 13.0 },
            { name: "Esquí de fondo, moderado", met: 8.0 },
            { name: "Esquí de fondo, competitivo", met: 14.0 },
            { name: "Esquí alpino, moderado", met: 6.0 },
            { name: "Esquí alpino, vigoroso", met: 8.0 },
            { name: "Snowboard", met: 6.0 },
            { name: "Luge", met: 7.0 },
            { name: "--- Otros deportes y actividades ---", met: 0 },
            { name: "Arquería", met: 3.5 },
            { name: "Atletismo (salto de altura, longitud, vallas)", met: 6.0 },
            { name: "Atletismo (lanzamiento de jabalina, disco)", met: 4.0 },
            { name: "Atletismo (lanzamiento de peso)", met: 6.0 },
            { name: "Bochas", met: 3.0 },
            { name: "Bolos", met: 3.0 },
            { name: "Equitación, general", met: 5.8 },
            { name: "Escalada en roca", met: 8.0 },
            { name: "Golf, caminando y cargando palos", met: 4.8 },
            { name: "Halterofilia, vigoroso", met: 6.0 },
            { name: "Halterofilia, ligero", met: 3.0 },
            { name: "Entrenamiento de hipertrofia (pesas), vigoroso", met: 6.0 },
            { name: "Pentatlón moderno", met: 11.0 },
            { name: "Skateboarding", met: 5.0 },
            { name: "Tiro (deportivo)", met: 2.5 },
            { name: "Triatlón", met: 10.0 },
            { name: "Yoga (Hatha)", met: 2.5 },
            { name: "Yoga (Power)", met: 4.0 },
            { name: "--- Actividades del hogar ---", met: 0 },
            { name: "Limpieza, ligera (quitar polvo)", met: 2.5 },
            { name: "Limpieza, pesada (fregar, aspirar)", met: 3.5 },
            { name: "Jardinería, general", met: 4.0 },
            { name: "Cortar el césped, caminando", met: 5.5 },
            { name: "Lavar el coche", met: 3.0 }
        ];

        function populateActivities() {
            const select = inputElements.activitySelect;
            select.innerHTML = '<option value="">Selecciona una actividad</option>';
            activityMETs.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.met;
                option.textContent = activity.name;
                if (activity.met === 0) {
                    option.disabled = true;
                    option.style.fontWeight = 'bold';
                    option.style.backgroundColor = '#f3f4f6';
                }
                select.appendChild(option);
            });
        }

        function createAccordionItem(item) { return `<div class="accordion-item border rounded-lg overflow-hidden"><button class="accordion-header w-full text-left p-4 bg-gray-50 hover:bg-gray-100 font-semibold flex justify-between items-center transition-colors"><span>${item.title}</span><svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content bg-white"><div class="p-4 border-t"><p class="font-semibold">${item.desc}</p><p class="mt-2 text-gray-600">${item.detail}</p></div></div></div>`; }
        document.getElementById('generales-accordion').innerHTML = metricas.generales.map(createAccordionItem).join('');
        document.getElementById('obstetricas-accordion').innerHTML = metricas.obstetricas.map(createAccordionItem).join('');
        document.getElementById('pediatricas-accordion').innerHTML = metricas.pediatricas.map(createAccordionItem).join('');
        document.getElementById('salud-mental-accordion').innerHTML = metricas.saludMental.map(createAccordionItem).join('');
        document.getElementById('dosis-accordion').innerHTML = metricas.dosis.map(createAccordionItem).join('');

        function switchSection(sectionId) {
            pageSections.forEach(section => section.classList.add('hidden'));
            const activeSection = document.getElementById(sectionId);
            if (activeSection) activeSection.classList.remove('hidden');

            navLinks.forEach(link => {
                const linkSection = link.getAttribute('data-section');
                const linkIsActive = linkSection === sectionId;
                
                link.classList.toggle('text-[#6B8E23]', linkIsActive);
                link.classList.toggle('font-bold', linkIsActive);
                link.classList.toggle('text-gray-700', !linkIsActive);
                link.classList.toggle('font-medium', !linkIsActive); // For mobile
            });

            mobileMenu.classList.add('-translate-x-full');
            menuOpenIcon.classList.remove('hidden');
            menuCloseIcon.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        switchSection('inicio-section');
        navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); switchSection(link.getAttribute('data-section')); }); });
        menuButton.addEventListener('click', () => { mobileMenu.classList.toggle('-translate-x-full'); menuOpenIcon.classList.toggle('hidden'); menuCloseIcon.classList.toggle('hidden'); });
        
        function updateCalculatorToggle(active) { if (active === 'adults') { adultsCalculator.classList.remove('hidden'); pediatricCalculator.classList.add('hidden'); showAdultsBtn.className = 'flex-1 px-4 py-2 text-sm font-medium transition-colors duration-200 rounded-l-lg text-white bg-[#6B8E23]'; showPediatricBtn.className = 'flex-1 px-4 py-2 text-sm font-medium transition-colors duration-200 rounded-r-lg text-[#6B8E23] bg-white hover:bg-gray-50'; } else { pediatricCalculator.classList.remove('hidden'); adultsCalculator.classList.add('hidden'); showPediatricBtn.className = 'flex-1 px-4 py-2 text-sm font-medium transition-colors duration-200 rounded-r-lg text-white bg-[#6B8E23]'; showAdultsBtn.className = 'flex-1 px-4 py-2 text-sm font-medium transition-colors duration-200 rounded-l-lg text-[#6B8E23] bg-white hover:bg-gray-50'; } }
        showAdultsBtn.addEventListener('click', () => updateCalculatorToggle('adults'));
        showPediatricBtn.addEventListener('click', () => updateCalculatorToggle('pediatric'));
        updateCalculatorToggle('adults');
        
        document.addEventListener('click', function(e) {
            const header = e.target.closest('.accordion-header');
            if (!header) return;

            const content = header.nextElementSibling;
            if (!content || !content.classList.contains('accordion-content')) return;

            const icon = header.querySelector('svg');
            const isCurrentlyOpen = content.style.maxHeight && content.style.maxHeight !== '0px';

            const parentAccordion = header.closest('#meds-list-container, #metricas-section, #mobile-menu');
            if (parentAccordion) {
                // Si NO es el acordeón del menú móvil, cierra los otros. Si es el del menú, permite múltiples abiertos.
                if (parentAccordion.id !== 'mobile-menu') {
                    parentAccordion.querySelectorAll('.accordion-header').forEach(otherHeader => {
                        if (otherHeader !== header) {
                            const otherContent = otherHeader.nextElementSibling;
                            if (otherContent && otherContent.classList.contains('accordion-content')) {
                                otherContent.style.maxHeight = null;
                            }
                            const otherIcon = otherHeader.querySelector('svg');
                            if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                        }
                    });
                }
            }

            if (!isCurrentlyOpen) {
                content.style.maxHeight = content.scrollHeight + 'px';
                if (icon) icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.maxHeight = null;
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        });

        function getInputs() { const inputs = {}; for (const key in inputElements) { const element = inputElements[key]; if (!element) continue; if (element.type === 'checkbox') { inputs[key] = element.checked; } else if (element.type === 'number' || element.type === 'date') { inputs[key] = element.value ? (element.type === 'date' ? element.value : parseFloat(element.value)) : NaN; } else { inputs[key] = element.value; } } return inputs; }
        function togglePregnancyOption() { if (inputElements.sexo.value === 'mujer') { embarazadaOption.classList.remove('hidden'); } else { embarazadaOption.classList.add('hidden'); inputElements.embarazada.checked = false; } calculateAll(); }
        function toggleSleepDetails() { if (inputElements.despiertaNoche.value === 'si') { despiertaNocheDetalles.classList.remove('hidden'); } else { despiertaNocheDetalles.classList.add('hidden'); } }
        function calculateAll() { const inputs = getInputs(); if (inputs.embarazada) { generalInputsSection.classList.add('hidden'); pregnancyInputsSection.classList.remove('hidden'); generalResultsSection.classList.add('hidden'); pregnancyResultsSection.classList.remove('hidden'); pregnancyExplanationSection.classList.remove('hidden'); macronutrientNote.classList.add('hidden'); calculatePregnancyMetrics(inputs); updateActionItems(inputs); } else { generalInputsSection.classList.remove('hidden'); pregnancyInputsSection.classList.add('hidden'); generalResultsSection.classList.remove('hidden'); pregnancyResultsSection.classList.add('hidden'); pregnancyExplanationSection.classList.add('hidden'); macronutrientNote.classList.remove('hidden'); calculateGeneralMetrics(inputs); updateActionItems(inputs); } calculatePediatricMetrics(inputs); }
        function calculatePregnancyMetrics(inputs) { const results = {}; const { altura, prePregnancyWeight, peso, lmpDate } = inputs; const today = new Date(); const lmp = new Date(lmpDate); let gestationalWeek = NaN; let edd = 'Fecha no calculada'; if (!isNaN(lmp.getTime())) { const msPerWeek = 1000 * 60 * 60 * 24 * 7; gestationalWeek = Math.floor((today.getTime() - lmp.getTime()) / msPerWeek); const eddMs = lmp.getTime() + (280 * 24 * 60 * 60 * 1000); edd = new Date(eddMs).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }); } let prePregnancyBMI = NaN; let recommendedGain = 'Necesitas peso antes del embarazo'; if (!isNaN(prePregnancyWeight) && !isNaN(altura)) { const alturaM = altura / 100; prePregnancyBMI = prePregnancyWeight / (alturaM * alturaM); if (prePregnancyBMI < 18.5) recommendedGain = '12.5 - 18 kg'; else if (prePregnancyBMI < 25) recommendedGain = '11.5 - 16 kg'; else if (prePregnancyBMI < 30) recommendedGain = '7 - 11.5 kg'; else recommendedGain = '5 - 9 kg'; } const currentGain = !isNaN(peso) && !isNaN(prePregnancyWeight) ? (peso - prePregnancyWeight).toFixed(1) : '-'; results.gestationalWeek = { value: gestationalWeek, edd: edd }; results.recommendedGain = { value: recommendedGain, currentGain: currentGain, prePregnancyBMI: prePregnancyBMI }; results.efw = calculateEFW(inputs.fetalDbp, inputs.fetalCc, inputs.fetalCa, inputs.fetalLf); results.bishop = calculateBishopScore(inputs); results.vbac = calculateVBACScore(inputs.edad, prePregnancyBMI, inputs.vbacPartoVaginalPrevio); results.analisisSueno = getSleepAnalysis(inputs); results.bienestarEmocional = getBienestarInterpretation(inputs); currentResults = results; updatePregnancyUI(results); }
        function updatePregnancyUI(results) { document.getElementById('gestational-week').textContent = !isNaN(results.gestationalWeek.value) ? `${results.gestationalWeek.value} semanas` : '-'; document.getElementById('edd-date').textContent = `FPP: ${results.gestationalWeek.edd}`; document.getElementById('recommended-gain').textContent = results.recommendedGain.value; document.getElementById('current-gain').textContent = `Ganancia actual: ${results.recommendedGain.currentGain} kg`; document.getElementById('gain-interpretation').textContent = `IMC pre-embarazo: ${!isNaN(results.recommendedGain.prePregnancyBMI) ? results.recommendedGain.prePregnancyBMI.toFixed(1) : '-'} (${getIMCInterpretation(results.recommendedGain.prePregnancyBMI)})`; document.getElementById('efw-value').textContent = isNaN(results.efw.value) ? '-' : `${results.efw.value.toFixed(0)} g`; document.getElementById('efw-interpretation').textContent = results.efw.interpretation; document.getElementById('bishop-value').textContent = isNaN(results.bishop.value) ? '-' : results.bishop.value; document.getElementById('bishop-interpretation').textContent = results.bishop.interpretation; document.getElementById('vbac-value').textContent = isNaN(results.vbac.value) ? '-' : `${results.vbac.value.toFixed(1)}%`; document.getElementById('vbac-interpretation').textContent = results.vbac.interpretation; document.getElementById('pregnancy-sueno-value').textContent = results.analisisSueno.value || '-'; document.getElementById('pregnancy-sueno-interpretation').textContent = results.analisisSueno.interpretation; document.getElementById('pregnancy-bienestar-value').textContent = results.bienestarEmocional.value || '-'; document.getElementById('pregnancy-bienestar-interpretation').textContent = results.bienestarEmocional.interpretation; }
        function getMetricsOrder(results) { return [ { id: 'imc', title: metricas.generales[0].title, value: isNaN(results.imc.value) ? '-' : results.imc.value.toFixed(2), interpretation: results.imc.interpretation }, { id: 'iac', title: metricas.generales[1].title, value: isNaN(results.iac.value) ? '-' : results.iac.value.toFixed(2) + '%', interpretation: results.iac.interpretation }, { id: 'absi', title: metricas.generales[2].title, value: isNaN(results.absi.value) ? '-' : results.absi.value.toFixed(4), interpretation: results.absi.interpretation }, { id: 'bri', title: metricas.generales[3].title, value: isNaN(results.bri.value) ? '-' : results.bri.value.toFixed(2), interpretation: results.bri.interpretation }, { id: 'vai', title: metricas.generales[4].title, value: isNaN(results.vai.value) ? '-' : results.vai.value.toFixed(2), interpretation: results.vai.interpretation }, { id: 'grasa-corporal', title: metricas.generales[5].title, value: isNaN(results.grasaCorporal.value) ? '-' : results.grasaCorporal.value.toFixed(2) + '%', interpretation: results.grasaCorporal.interpretation }, { id: 'ffmi', title: metricas.generales[6].title, value: isNaN(results.ffmi.value) ? '-' : results.ffmi.value.toFixed(2), interpretation: results.ffmi.interpretation }, { id: 'peso-ideal', title: metricas.generales[7].title, value: `Ideal: ${isNaN(results.pesoIdeal.value) ? '-' : results.pesoIdeal.value.toFixed(1)}kg<br>Ajustado: ${isNaN(results.pesoAjustado.value) ? '-' : results.pesoAjustado.value.toFixed(1)}kg`, interpretation: '' }, { id: 'distribucion', title: metricas.generales[8].title, value: `ICC: ${isNaN(results.icc.value) ? '-' : results.icc.value.toFixed(2)}<br>ICA: ${isNaN(results.ica.value) ? '-' : results.ica.value.toFixed(2)}`, interpretation: '' }, { id: 'tmb', title: metricas.generales[9].title, value: isNaN(results.tmb.value) ? '-' : results.tmb.value.toFixed(0), interpretation: 'Calorías en reposo' }, { id: 'get', title: metricas.generales[10].title, value: isNaN(results.get.value) ? '-' : results.get.value.toFixed(0), interpretation: 'Calorías diarias totales' }, { id: 'calories-burned', title: metricas.generales[11].title, value: results.caloriesBurned.value, interpretation: results.caloriesBurned.interpretation }, { id: 'macros', title: metricas.generales[12].title, value: results.macros.value, interpretation: 'Proteínas | Grasas | Carbohidratos' }, { id: 'homa-ir', title: metricas.generales[13].title, value: isNaN(results.homaIr.value) ? '-' : results.homaIr.value.toFixed(2), interpretation: results.homaIr.interpretation }, { id: 'ast-alt', title: metricas.generales[14].title, value: isNaN(results.astAlt.value) ? '-' : results.astAlt.value.toFixed(2), interpretation: results.astAlt.interpretation }, { id: 'pam', title: metricas.generales[15].title, value: isNaN(results.pam.value) ? '-' : results.pam.value.toFixed(2) + ' mmHg', interpretation: results.pam.interpretation }, { id: 'tfge', title: metricas.generales[16].title, value: isNaN(results.tfge.value) ? '-' : results.tfge.value.toFixed(0) + ' ml/min', interpretation: results.tfge.interpretation }, { id: 'ascvd', title: metricas.generales[17].title, value: isNaN(parseFloat(results.ascvd.value)) ? '-' : results.ascvd.value + '%', interpretation: results.ascvd.interpretation }, { id: 'framingham', title: metricas.generales[18].title, value: isNaN(results.framingham.value) ? '-' : `${results.framingham.value}%`, interpretation: results.framingham.interpretation }, { id: 'score', title: metricas.generales[19].title, value: isNaN(results.score.value) ? '-' : `< ${results.score.value}%`, interpretation: results.score.interpretation }, { id: 'castelli', title: metricas.generales[20].title, value: isNaN(results.castelli.value) ? '-' : results.castelli.value.toFixed(2), interpretation: results.castelli.interpretation }, { id: 'ipa', title: metricas.generales[21].title, value: isNaN(results.ipa.value) ? '-' : results.ipa.value.toFixed(2), interpretation: results.ipa.interpretation }, { id: 'sueno', title: metricas.generales[22].title, value: results.analisisSueno.value || '-', interpretation: results.analisisSueno.interpretation }, { id: 'bienestar', title: metricas.generales[23].title, value: results.bienestarEmocional.value || '-', interpretation: results.bienestarEmocional.interpretation }, ]; }
        function calculateGeneralMetrics(inputs) { const results = { imc: calculateIMC(inputs.peso, inputs.altura), iac: calculateIAC(inputs.cadera, inputs.altura), absi: calculateABSI(inputs.cintura, inputs.altura, calculateIMC(inputs.peso, inputs.altura).value), bri: calculateBRI(inputs.cintura, inputs.altura), grasaCorporal: calculateGrasaCorporal(inputs.sexo, inputs.cintura, inputs.cuello, inputs.altura, inputs.cadera), vai: calculateVAI(inputs.sexo, inputs.cintura, inputs.trigliceridos, inputs.hdl, calculateIMC(inputs.peso, inputs.altura).value), pesoIdeal: calculatePesoIdeal(inputs.altura, inputs.sexo), icc: calculateICC(inputs.cintura, inputs.cadera), ica: calculateICA(inputs.cintura, inputs.altura), tmb: calculateTMB(inputs.sexo, inputs.peso, inputs.altura, inputs.edad), homaIr: calculateHOMA_IR(inputs.glicemia, inputs.insulina), astAlt: calculateASTALT(inputs.ast, inputs.alt), pam: calculatePAM(inputs.pas, inputs.pad), tfge: calculateTFGe(inputs.creatinina, inputs.sexo, inputs.edad), ascvd: calculateASCVD(inputs.sexo, inputs.edad, inputs.colesterolTotal, inputs.hdl, inputs.pas, (inputs.anosFumando > 0 || inputs.cigarrillosDiarios > 0), inputs.diabetes), framingham: calculateFramingham(inputs.sexo, inputs.edad, inputs.colesterolTotal, inputs.hdl, inputs.pas, (inputs.anosFumando > 0 || inputs.cigarrillosDiarios > 0), inputs.diabetes), score: calculateSCORE(inputs.sexo, inputs.edad, inputs.colesterolTotal, inputs.pas, (inputs.anosFumando > 0 || inputs.cigarrillosDiarios > 0)), castelli: calculateCastelli(inputs.colesterolTotal, inputs.hdl), ipa: calculateIPA(inputs.anosFumando, inputs.cigarrillosDiarios), caloriesBurned: calculateCaloriesBurnedActivity(inputs.peso, inputs.activitySelect), analisisSueno: getSleepAnalysis(inputs), bienestarEmocional: getBienestarInterpretation(inputs) }; results.ffmi = calculateFFMI(inputs.peso, inputs.altura, results.grasaCorporal.value); results.pesoAjustado = calculatePesoAjustado(inputs.peso, results.pesoIdeal.value); results.get = calculateGET(results.tmb.value, inputs.actividad); results.macros = calculateMacros(results.get.value, inputs.peso); currentResults = results; updateGeneralUI(results); updateChart([ isNaN(results.imc.value) ? 0 : results.imc.value, isNaN(results.iac.value) ? 0 : results.iac.value, isNaN(results.absi.value) ? 0 : results.absi.value * 100, isNaN(results.bri.value) ? 0 : results.bri.value, isNaN(results.vai.value) ? 0 : results.vai.value, isNaN(results.grasaCorporal.value) ? 0 : results.grasaCorporal.value, isNaN(parseFloat(results.framingham.value)) ? 0 : parseFloat(results.framingham.value) ]); }
        function createResultCard(id, title, value, interpretation) { return ` <div class="bg-gray-50 p-6 rounded-lg shadow interactive-card"> <h3 class="text-xl font-semibold mb-2">${title}</h3> <p id="${id}-value" class="text-3xl font-bold text-[#6B8E23] mb-1">${value}</p> <p id="${id}-interpretation" class="text-md text-gray-700">${interpretation}</p> </div>`; }
        function updateGeneralUI(results) { const resultsContainer = document.getElementById('results'); const metricsOrder = getMetricsOrder(results); resultsContainer.innerHTML = metricsOrder.map(m => createResultCard(m.id, m.title, m.value, m.interpretation)).join(''); }
        function calculatePediatricMetrics(inputs) { const { pediatricSexo, pediatricEdadMeses, pediatricPeso, pediatricAltura, pliegueTriceps, pliegueSubescapular } = inputs; if (isNaN(pediatricEdadMeses) || isNaN(pediatricPeso) || isNaN(pediatricAltura) || pediatricEdadMeses <= 0) { updatePediatricUI(null); return; } const pediatricIMC = pediatricPeso / Math.pow(pediatricAltura / 100, 2); const ageYears = pediatricEdadMeses / 12; const L = pediatricSexo === 'niño' ? 1 : 1.2; const M = pediatricSexo === 'niño' ? 16 + (ageYears * 0.3) : 15.5 + (ageYears * 0.3); const S = 0.12; const Z = (Math.pow(pediatricIMC / M, L) - 1) / (L * S); const percentile = Math.round(cdf(Z) * 100); let bmiInterpretation = ''; if(percentile < 5) bmiInterpretation = 'Bajo peso'; else if (percentile < 85) bmiInterpretation = 'Peso saludable'; else if (percentile < 95) bmiInterpretation = 'Sobrepeso'; else bmiInterpretation = 'Obesidad'; const bodyFat = calculateSlaughterBodyFat(pediatricSexo, pliegueTriceps, pliegueSubescapular, ageYears > 8); const geb = calculatePediatricGEB(pediatricSexo, ageYears, pediatricPeso); const results = { bmiPercentile: { value: percentile, interpretation: bmiInterpretation }, bodyFat: bodyFat, geb: geb }; currentPediatricResults = results; updatePediatricUI(results); }
        function updatePediatricUI(results) { const container = document.getElementById('pediatric-results-cards'); if (!results) { container.innerHTML = '<p class="col-span-full text-center text-gray-600">Por favor, introduce los datos del niño para ver los resultados.</p>'; updatePediatricActionItems(null); return; } container.innerHTML = ` ${createResultCard('ped-imc', 'IMC por percentil', `${results.bmiPercentile.value}`, results.bmiPercentile.interpretation)} ${createResultCard('ped-fat', '% Grasa corporal (Slaughter)', isNaN(results.bodyFat.value) ? '-' : `${results.bodyFat.value.toFixed(1)}%`, results.bodyFat.interpretation)} ${createResultCard('ped-geb', 'Gasto energético basal', isNaN(results.geb.value) ? '-' : `${results.geb.value.toFixed(0)} kcal/día`, results.geb.interpretation)} `; updatePediatricActionItems(results); }
        function updateActionItems(inputs) { const { altura, peso, horasSueno, somnolenciaDiurna, bienestarEmocional, embarazada } = inputs; let suggestionsHTML = ''; if (embarazada) { suggestionsHTML += '<li><strong>Cuidado prenatal:</strong> Es crucial mantener todas las citas con tu médico para monitorear tu salud y la del bebé.</li>'; } else { const imc = calculateIMC(peso, altura).value; if (!isNaN(imc)) { if (imc < 18.5) suggestionsHTML += '<li><strong>Bajo peso:</strong> Tu IMC indica un peso por debajo de lo saludable. Un nutricionista puede ayudarte.</li>'; else if (imc >= 25 && imc < 30) suggestionsHTML += '<li><strong>Sobrepeso:</strong> Considera incorporar más actividad física y revisar tu alimentación.</li>'; else if (imc >= 30) suggestionsHTML += '<li><strong>Obesidad:</strong> Es importante consultar a un médico para crear un plan de salud integral.</li>'; } } if (!isNaN(horasSueno) && horasSueno < 7) { suggestionsHTML += `<li><strong>Descanso adecuado:</strong> Dormir menos de 7 horas puede ser especialmente desafiante${embarazada ? ' durante el embarazo' : ''}. Prioriza el descanso.</li>`; } if (somnolenciaDiurna === 'frecuentemente') { suggestionsHTML += `<li><strong>Somnolencia diurna:</strong> Sentirse muy somnoliento/a es común${embarazada ? ', pero si es excesivo, coméntalo con tu médico' : '. Puede indicar un sueño no reparador'}.</li>`; } if (!isNaN(bienestarEmocional) && bienestarEmocional <= 4) { suggestionsHTML += '<li><strong>Bienestar emocional:</strong> Tu bienestar es una prioridad. Si te sientes abrumado/a, es importante buscar apoyo.</li>'; } if (suggestionsHTML === '') { suggestionsHTML = '<li><strong>¡Vas por buen camino!</strong> Sigue cuidándote y manteniendo hábitos saludables.</li>'; } actionItemsList.innerHTML = suggestionsHTML; }
        function updatePediatricActionItems(results) { if (!results || isNaN(results.bmiPercentile.value)) { pediatricActionItemsList.innerHTML = '<li>Introduce los datos para ver sugerencias.</li>'; return; } const percentile = results.bmiPercentile.value; let suggestionsHTML = ''; if (percentile < 5) { suggestionsHTML += '<li><strong>Bajo peso:</strong> El percentil de IMC es bajo. Es importante hablar con el pediatra para evaluar la nutrición y el crecimiento del niño/a.</li>'; } else if (percentile >= 85 && percentile < 95) { suggestionsHTML += '<li><strong>Sobrepeso:</strong> El percentil de IMC indica sobrepeso. Es un buen momento para fomentar hábitos saludables en familia, como una dieta balanceada y actividad física regular.</li>'; } else if (percentile >= 95) { suggestionsHTML += '<li><strong>Obesidad:</strong> El percentil de IMC es elevado. Se recomienda una evaluación médica para crear un plan de manejo que apoye un crecimiento saludable.</li>'; } else { suggestionsHTML = '<li><strong>¡Crecimiento saludable!</strong> El percentil de IMC se encuentra en un rango saludable. Continúa fomentando buenos hábitos.</li>'; } pediatricActionItemsList.innerHTML = suggestionsHTML; }
        function getIMCInterpretation(value) { if (isNaN(value)) return ''; if (value < 18.5) return 'Bajo peso'; else if (value < 25) return 'Normal'; else if (value < 30) return 'Sobrepeso'; else return 'Obesidad'; }
        function calculateIMC(peso, altura) { if (isNaN(peso) || isNaN(altura) || altura <= 0) return { value: NaN, interpretation: '' }; const alturaM = altura / 100; const value = peso / (alturaM * alturaM); return { value, interpretation: getIMCInterpretation(value) }; }
        function calculateIAC(cadera, altura) { if (isNaN(cadera) || isNaN(altura) || altura <= 0) return { value: NaN, interpretation: '' }; const alturaM = altura / 100; const value = (cadera / Math.pow(alturaM, 1.5)) - 18; let interpretation = 'Normal'; return { value, interpretation }; }
        function calculateABSI(cintura, altura, imc) { if (isNaN(cintura) || isNaN(altura) || isNaN(imc) || altura <= 0) return { value: NaN, interpretation: '' }; const alturaM = altura / 100; const cinturaM = cintura / 100; const value = cinturaM / (Math.pow(imc, 2/3) * Math.pow(alturaM, 0.5)); let interpretation = (value > 0.083) ? 'Riesgo elevado' : 'Riesgo normal'; return { value, interpretation }; }
        function calculateBRI(cintura, altura) { if (isNaN(cintura) || isNaN(altura) || altura <= 0) return { value: NaN, interpretation: '' }; const value = 364.2 - 365.5 * Math.sqrt(1 - Math.pow(((cintura / 100) / (2 * Math.PI)), 2) / Math.pow((0.5 * (altura / 100)), 2)); let interpretation = (value > 3.0) ? 'Riesgo elevado' : 'Riesgo bajo'; return { value, interpretation }; }
        function calculateVAI(sexo, cintura, trigliceridos, hdl, imc) { if (isNaN(cintura) || isNaN(trigliceridos) || isNaN(hdl) || isNaN(imc)) return { value: NaN, interpretation: '' }; const tg_mmol = trigliceridos / 88.5; const hdl_mmol = hdl / 38.67; let vai = (sexo === 'hombre') ? (cintura / (39.68 + (1.88 * imc))) * (tg_mmol / 1.03) * (1.31 / hdl_mmol) : (cintura / (36.58 + (1.89 * imc))) * (tg_mmol / 0.81) * (1.52 / hdl_mmol); const interpretation = vai > 1 ? 'Riesgo elevado' : 'Riesgo normal'; return { value: vai, interpretation }; }
        function calculateGrasaCorporal(sexo, cintura, cuello, altura, cadera) { if (isNaN(cintura) || isNaN(cuello) || isNaN(altura)) return { value: NaN, interpretation: '' }; let value; let interpretation = ''; if (sexo === 'hombre') { value = 495 / (1.0324 - 0.19077 * Math.log10(cintura - cuello) + 0.15456 * Math.log10(altura)) - 450; if (value < 6) interpretation = 'Esencial'; else if (value < 14) interpretation = 'Atleta'; else if (value < 18) interpretation = 'Fitness'; else if (value < 25) interpretation = 'Aceptable'; else interpretation = 'Obesidad'; } else { if (isNaN(cadera)) return { value: NaN, interpretation: '' }; value = 495 / (1.29579 - 0.35004 * Math.log10(cintura + cadera - cuello) + 0.22100 * Math.log10(altura)) - 450; if (value < 14) interpretation = 'Esencial'; else if (value < 21) interpretation = 'Atleta'; else if (value < 25) interpretation = 'Fitness'; else if (value < 32) interpretation = 'Aceptable'; else interpretation = 'Obesidad'; } return { value, interpretation }; }
        function calculateFFMI(peso, altura, grasaCorporal) { if (isNaN(peso) || isNaN(altura) || isNaN(grasaCorporal)) return { value: NaN, interpretation: '' }; const alturaM = altura / 100; const masaLibreDeGrasaKg = peso * (1 - (grasaCorporal / 100)); const value = masaLibreDeGrasaKg / (alturaM * alturaM); let interpretation = ''; if (value < 18) interpretation = 'Bajo'; else if (value < 22) interpretation = 'Promedio'; else if (value < 25) interpretation = 'Alto'; else interpretation = 'Excelente'; return { value, interpretation }; }
        function calculatePesoIdeal(altura, sexo) {
            if (isNaN(altura) || altura <= 152.4) return { value: NaN }; // La fórmula de Devine es para estaturas > 5 pies (152.4 cm)
            const alturaInches = altura / 2.54;
            const inchesOver5Feet = alturaInches - 60;
            const value = (sexo === 'hombre') ? 50 + (2.3 * inchesOver5Feet) : 45.5 + (2.3 * inchesOver5Feet);
            return { value };
        }
        function calculatePesoAjustado(peso, pesoIdeal) { if (isNaN(peso) || isNaN(pesoIdeal)) return { value: NaN }; return { value: pesoIdeal + 0.4 * (peso - pesoIdeal) }; }
        function calculateICC(cintura, cadera) { if (isNaN(cintura) || isNaN(cadera) || cadera === 0) return { value: NaN }; return { value: cintura / cadera }; }
        function calculateICA(cintura, altura) { if (isNaN(cintura) || isNaN(altura) || altura === 0) return { value: NaN }; return { value: cintura / altura }; }
        function calculateTMB(sexo, peso, altura, edad) { if (isNaN(peso) || isNaN(altura) || isNaN(edad)) return { value: NaN }; return { value: (sexo === 'hombre') ? (10 * peso) + (6.25 * altura) - (5 * edad) + 5 : (10 * peso) + (6.25 * altura) - (5 * edad) - 161 }; }
        function calculateGET(tmb, actividad) { if (isNaN(tmb) || !actividad) return { value: NaN }; return { value: tmb * parseFloat(actividad) }; }
        function calculateHOMA_IR(glicemia, insulina) { if (isNaN(glicemia) || isNaN(insulina)) return { value: NaN, interpretation: 'Faltan datos.' }; const value = (glicemia * insulina) / 405; let interpretation = value < 2.5 ? 'Normal' : 'Resistencia a la insulina.'; return { value, interpretation }; }
        function calculateASTALT(ast, alt) { if (isNaN(ast) || isNaN(alt) || alt === 0) return { value: NaN, interpretation: '' }; const value = ast / alt; let interpretation = (value > 1.0) ? 'Posible daño hepático' : 'Normal'; return { value, interpretation }; }
        function calculatePAM(pas, pad) { if (isNaN(pas) || isNaN(pad)) return { value: NaN, interpretation: '' }; const value = (pas + 2 * pad) / 3; let interpretation = (value > 100) ? 'Hipertensión' : (value < 70) ? 'Hipotensión' : 'Normal'; return { value, interpretation }; }
        function calculateTFGe(creatinina, sexo, edad) { if (isNaN(creatinina) || isNaN(edad)) return { value: NaN, interpretation: '' }; let kappa = sexo === 'mujer' ? 0.7 : 0.9; let alpha = sexo === 'mujer' ? -0.329 : -0.411; let genderFactor = sexo === 'mujer' ? 1.018 : 1; let value = 141 * Math.pow(Math.min(creatinina / kappa, 1), alpha) * Math.pow(Math.max(creatinina / kappa, 1), -1.209) * Math.pow(0.993, edad) * genderFactor; let interpretation = ''; if (value >= 90) interpretation = 'Función renal normal.'; else if (value >= 60) interpretation = 'Levemente disminuida.'; else if (value >= 30) interpretation = 'Disfunción moderada.'; else if (value >= 15) interpretation = 'Disfunción severa.'; else interpretation = 'Fallo renal.'; return { value, interpretation }; }
        function calculateASCVD(sexo, edad, colTotal, hdl, pas, fuma, diabetes) { if (isNaN(edad) || isNaN(colTotal) || isNaN(hdl) || isNaN(pas)) return { value: NaN, interpretation: 'Faltan datos.' }; let l_age = Math.log(edad); let l_tc = Math.log(colTotal); let l_hdl = Math.log(hdl); let l_sbp = Math.log(pas); let sum_b; if (sexo === 'mujer') { sum_b = -29.799 * l_age + 4.884 * Math.pow(l_age, 2) + 13.540 * l_tc - 3.375 * l_age * l_tc - 13.578 * l_hdl + 3.149 * l_age * l_hdl + 2.019 * l_sbp + (fuma ? 7.574 - 1.665 * l_age : 0) + (diabetes ? 0.661 : 0); let prob = 1 - Math.pow(0.9665, Math.exp(sum_b - (-29.18))); return { value: (prob * 100).toFixed(1), interpretation: prob < 0.05 ? 'Riesgo bajo' : prob < 0.2 ? 'Riesgo intermedio' : 'Riesgo alto' }; } else { sum_b = 12.344 * l_age + 11.853 * l_tc - 2.664 * l_age * l_tc - 7.990 * l_hdl + 1.769 * l_age * l_hdl + 1.797 * l_sbp + (fuma ? 7.837 - 1.795 * l_age : 0) + (diabetes ? 0.658 : 0); let prob = 1 - Math.pow(0.9144, Math.exp(sum_b - 61.18)); return { value: (prob * 100).toFixed(1), interpretation: prob < 0.05 ? 'Riesgo bajo' : prob < 0.2 ? 'Riesgo intermedio' : 'Riesgo alto' }; } }
        function calculateIPA(anos, cigarrillos) { if (isNaN(anos) || isNaN(cigarrillos) || (anos === 0 && cigarrillos === 0)) return { value: NaN, interpretation: 'No aplica.' }; const value = (anos * cigarrillos) / 20; let interpretation = value <= 10 ? 'Riesgo bajo de EPOC' : value <= 20 ? 'Riesgo moderado' : 'Riesgo alto'; return { value, interpretation }; }
        function calculateCaloriesBurnedActivity(peso, metValue) { const met = parseFloat(metValue); if (isNaN(peso) || isNaN(met) || met === 0) { return { value: '-', interpretation: '' }; } const calories = met * 3.5 * peso / 200 * 60; return { value: calories.toFixed(0), interpretation: 'Calorías por hora (aprox.)' }; }
        function calculateMacros(get, peso) { if (isNaN(get) || isNaN(peso)) return { value: '-', interpretation: '' }; const proteinMinGrams = peso * 1.6; const proteinMaxGrams = peso * 2.5; const fatMinGrams = (get * 0.20) / 9; const fatMaxGrams = (get * 0.30) / 9; const carbsMinGrams = (get * 0.40) / 4; const carbsMaxGrams = (get * 0.55) / 4; const value = `P: ${proteinMinGrams.toFixed(0)}-${proteinMaxGrams.toFixed(0)}g | G: ${fatMinGrams.toFixed(0)}-${fatMaxGrams.toFixed(0)}g | C: ${carbsMinGrams.toFixed(0)}-${carbsMaxGrams.toFixed(0)}g`; return { value, interpretation: '' }; }
        function calculateFramingham(sexo, edad, colTotal, hdl, pas, fuma, diabetes) { if (isNaN(edad) || isNaN(colTotal) || isNaN(hdl) || isNaN(pas)) return { value: NaN, interpretation: 'Faltan datos.' }; let points = 0; if (sexo === 'hombre') { if (edad <= 34) points -= 9; else if (edad <= 39) points -= 4; else if (edad <= 49) points += 3; else if (edad <= 54) points += 6; else if (edad <= 59) points += 8; else if (edad <= 64) points += 10; else if (edad <= 69) points += 11; else if (edad <= 74) points += 12; else points += 13; if (fuma) { if (edad <= 39) points += 8; else if (edad <= 49) points += 5; else if (edad <= 59) points += 3; else points += 1; } if(colTotal > 160) { if (colTotal <= 199) points += 4; else if (colTotal <= 239) points += 7; else if (colTotal <= 279) points += 9; else points += 11; } if (hdl < 40) points += 2; else if (hdl <= 49) points += 1; else if (hdl >= 60) points -= 1; if (pas >= 130 && pas <= 139) points += 1; else if (pas <= 159) points += 2; else if (pas >= 160) points += 3; if (diabetes) points += 3; const riskMap = {0:1,1:1,2:1,3:1,4:1,5:2,6:2,7:2,8:3,9:3,10:4,11:4,12:5,13:6,14:8,15:10,16:12,17:16,18:20,19:25,20:30}; let risk = riskMap[Math.max(0, Math.min(20, points))] || 30; return { value: risk, interpretation: risk < 10 ? 'Riesgo bajo' : risk <= 20 ? 'Intermedio' : 'Alto' }; } else { if (edad <= 34) points -= 7; else if (edad <= 39) points -= 3; else if (edad <= 49) points += 3; else if (edad <= 54) points += 6; else if (edad <= 59) points += 8; else if (edad <= 64) points += 10; else if (edad <= 69) points += 12; else if (edad <= 74) points += 14; else points += 16; if (fuma) { if (edad <= 39) points += 9; else if (edad <= 49) points += 7; else if (edad <= 59) points += 4; else if (edad <= 69) points += 2; else points += 1; } if(colTotal > 160) {if (colTotal <= 199) points += 4; else if (colTotal <= 239) points += 8; else if (colTotal <= 279) points += 11; else points += 13;} if (hdl < 40) points += 2; else if (hdl <= 49) points += 1; else if (hdl >= 60) points -= 1; if (pas >= 120 && pas <= 129) points += 1; else if (pas <= 139) points += 2; else if (pas <= 159) points += 4; else if (pas >= 160) points += 5; if (diabetes) points += 4; const riskMap = {0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:2,10:2,11:2,12:3,13:3,14:4,15:5,16:6,17:7,18:9,19:11,20:14,21:17,22:22,23:27,24:30}; let risk = riskMap[Math.max(0, Math.min(24, points))] || 30; return { value: risk, interpretation: risk < 10 ? 'Riesgo bajo' : risk <= 20 ? 'Intermedio' : 'Alto' }; } }
        function calculateSCORE(sexo, edad, colTotal, pas, fuma) { if (isNaN(edad) || isNaN(colTotal) || isNaN(pas)) return { value: NaN, interpretation: 'Faltan datos.'}; let risk = 1; if(edad > 50) risk += 1; if(edad > 60) risk += 2; if(pas > 140) risk += 1; if(pas > 160) risk += 2; if(colTotal > 200) risk += 1; if(colTotal > 240) risk += 2; if(fuma) risk += 2; if(sexo === 'hombre') risk += 1; let riskCategory = 1; if(risk > 10) riskCategory = 10; else if (risk > 6) riskCategory = 5; else if (risk > 4) riskCategory = 3; let interpretation = 'Riesgo bajo'; if(riskCategory >= 5) interpretation = 'Riesgo alto'; else if(riskCategory >= 3) interpretation = 'Riesgo moderado'; return { value: riskCategory, interpretation }; }
        function calculateCastelli(colTotal, hdl) { if(isNaN(colTotal) || isNaN(hdl) || hdl === 0) return { value: NaN, interpretation: 'Faltan datos.' }; const value = colTotal / hdl; let interpretation = 'Riesgo bajo'; if(value > 5.0) interpretation = 'Riesgo alto'; else if(value >= 3.5) interpretation = 'Riesgo moderado'; return { value, interpretation }; }
        function cdf(z) { const p = 0.3275911, a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429; const sign = z < 0 ? -1 : 1; const x = Math.abs(z) / Math.sqrt(2.0); const t = 1.0 / (1.0 + p * x); const erf = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x); return 0.5 * (1.0 + sign * erf); }
        function calculateSlaughterBodyFat(sexo, triceps, subscapular, isPubertal) { if(isNaN(triceps) || isNaN(subscapular)) return { value: NaN, interpretation: 'Faltan pliegues.' }; const sumPliegues = triceps + subscapular; let value = NaN; if(sexo === 'niño'){ value = sumPliegues > 35 ? 0.735 * sumPliegues + 1.0 : 0.61 * sumPliegues + 5.1; } else { value = sumPliegues > 35 ? 0.61 * sumPliegues + 5.1 : 0.546 * sumPliegues + 9.7; } return { value: value, interpretation: 'Estimación.' }; }
        function calculatePediatricGEB(sexo, edadAnos, peso) { if(isNaN(edadAnos) || isNaN(peso)) return { value: NaN, interpretation: '' }; let value = NaN; if(sexo === 'niño'){ if(edadAnos < 3) value = 60.9 * peso - 54; else if(edadAnos < 10) value = 22.7 * peso + 495; else if(edadAnos < 18) value = 17.5 * peso + 651; } else { if(edadAnos < 3) value = 61.0 * peso - 51; else if(edadAnos < 10) value = 22.5 * peso + 499; else if(edadAnos < 18) value = 12.2 * peso + 746; } return { value: value, interpretation: 'Calorías en reposo.' }; }
        function calculateEFW(dbp, cc, ca, lf) { if(isNaN(ca) || isNaN(lf)) return { value: NaN, interpretation: 'Faltan CA y LF.' }; const log10PFE = 1.3596 - (0.00386 * (ca/10) * (lf/10)) + (0.0064 * (cc/10)) + (0.00061 * (dbp/10) * (ca/10)) + (0.0424 * (ca/10)) + (0.174 * (lf/10)); const value = Math.pow(10, log10PFE); return { value, interpretation: 'Error de ±15%.' }; }
        function calculateBishopScore(inputs) { const { bishopDilatacion, bishopBorramiento, bishopConsistencia, bishopPosicion, bishopEstacion } = inputs; const score = parseInt(bishopDilatacion) + parseInt(bishopBorramiento) + parseInt(bishopConsistencia) + parseInt(bishopPosicion) + parseInt(bishopEstacion); if(isNaN(score)) return { value: NaN, interpretation: 'Faltan datos.' }; let interpretation = score >= 8 ? 'Favorable para inducción' : 'Desfavorable'; return { value: score, interpretation }; }
        function calculateVBACScore(edad, imc, partoVaginalPrevio) { if (isNaN(edad) || isNaN(imc)) return { value: NaN, interpretation: 'Faltan datos.' }; let baseProb = 70; if (imc >= 30) baseProb -= 10; if (imc >= 40) baseProb -= 10; if (edad >= 40) baseProb -= 5; if (partoVaginalPrevio) baseProb += 15; const value = Math.max(20, Math.min(95, baseProb)); return { value, interpretation: 'Probabilidad de PVDC.' }; }
        function getSleepAnalysis(inputs) { const { horasSueno, despiertaNoche, vecesDespierta, porqueDespierta, somnolenciaDiurna } = inputs; if (isNaN(horasSueno)) return { value: '-', interpretation: 'Ingresa horas de sueño.' }; let interpretation = `Duermes ${horasSueno} horas. `; if (despiertaNoche === 'si') { interpretation += `Te despiertas ${!isNaN(vecesDespierta) ? vecesDespierta : ''} veces`; interpretation += porqueDespierta ? ` (por: ${porqueDespierta}). ` : '. '; } else { interpretation += 'No sueles despertarte. '; } if (somnolenciaDiurna === 'frecuentemente') { interpretation += 'Sientes somnolencia frecuente.'; } return { value: `${horasSueno} horas`, interpretation }; }
        function getBienestarInterpretation(inputs) { const { bienestarEmocional, emocionPrincipal } = inputs; if (!bienestarEmocional) return { value: '-', interpretation: 'Selecciona tu bienestar.' }; let interpretation = `Tu bienestar es de ${bienestarEmocional}/10. `; if (emocionPrincipal) { interpretation += `Emoción principal: ${emocionPrincipal}.`; } return { value: `${bienestarEmocional}/10`, interpretation }; }
        
        function updateChart(data) { const chartColors = ['#6B8E23', '#8FB158', '#556B2F', '#A8C57D', '#41521C', '#C1D8A8', '#2E3A13']; if (!healthChart) { const ctx = document.getElementById('healthChart').getContext('2d'); healthChart = new Chart(ctx, { type: 'bar', data: { labels: ['IMC', 'IAC', 'ABSI', 'BRI', 'VAI', '% Grasa', 'Riesgo Fram.'], datasets: [{ label: 'Tus Valores', data: data, backgroundColor: chartColors, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } }); } else { healthChart.data.datasets[0].data = data; healthChart.update(); } }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            const errorIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            
            toast.innerHTML = `${isError ? errorIcon : successIcon} <span>${message}</span>`;
            
            const baseClasses = 'fixed bottom-5 left-5 right-5 sm:left-auto sm:right-5 sm:w-auto sm:max-w-md text-white py-3 px-5 rounded-lg shadow-2xl transition-all duration-500 ease-in-out transform no-print flex items-center gap-3 z-50 text-center sm:text-left justify-center sm:justify-start';
            const colorClasses = isError 
                ? 'bg-red-500' 
                : 'bg-[#6B8E23]';

            toast.className = `${baseClasses} ${colorClasses} opacity-0 translate-y-10`;

            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-10');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10); 

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 4000); 
        }

        function copyToClipboard(text, successMessage) { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); showToast(successMessage); } catch (err) { showToast('Error al copiar los resultados.', true); } document.body.removeChild(textArea); }
        
        function copyResults() {
            const isEmbarazada = inputElements.embarazada.checked;
            if (isEmbarazada) {
                if (Object.keys(currentResults).length === 0 || isNaN(currentResults.gestationalWeek?.value)) {
                    showToast("Calcula los resultados obstétricos primero.", true);
                    return;
                }
                let shareText = "--- Resumen de salud obstétrica ---\n\n";
                shareText += "== Seguimiento prenatal ==\n";
                shareText += `Semana gestacional: ${!isNaN(currentResults.gestationalWeek.value) ? currentResults.gestationalWeek.value + ' semanas' : '-'}\n`;
                shareText += `FPP: ${currentResults.gestationalWeek.edd}\n`;
                shareText += `Ganancia de peso recomendada: ${currentResults.recommendedGain.value}\n`;
                shareText += `Ganancia actual: ${currentResults.recommendedGain.currentGain} kg\n`;
                shareText += `Peso fetal estimado: ${isNaN(currentResults.efw.value) ? '-' : currentResults.efw.value.toFixed(0) + ' g'}\n`;
                shareText += `Puntuación de Bishop: ${isNaN(currentResults.bishop.value) ? '-' : currentResults.bishop.value} (${currentResults.bishop.interpretation})\n`;
                shareText += `Probabilidad de éxito de PVDC: ${isNaN(currentResults.vbac.value) ? '-' : currentResults.vbac.value.toFixed(1) + '%'} (${currentResults.vbac.interpretation})\n\n`;
                shareText += "== Bienestar ==\n";
                shareText += `Análisis del sueño: ${currentResults.analisisSueno.value}. ${currentResults.analisisSueno.interpretation}\n`;
                shareText += `Bienestar emocional: ${currentResults.bienestarEmocional.value}. ${currentResults.bienestarEmocional.interpretation}\n`;
                const notes = document.getElementById('doctor-notes').value;
                if (notes.trim()) {
                    shareText += `\n== Notas para mi médico ==\n${notes}`;
                }
                copyToClipboard(shareText, "Resultados obstétricos copiados.");
            } else {
                if (Object.keys(currentResults).length === 0 || isNaN(currentResults.imc?.value)) {
                    showToast("Calcula los resultados de adulto primero.", true);
                    return;
                }
                let shareText = "--- Resumen de salud integral ---\n\n";
                shareText += "== Indicadores clave ==\n";
                const metricsOrder = getMetricsOrder(currentResults);
                metricsOrder.forEach(m => {
                    const cleanValue = m.value.toString().replace(/<br>/g, ' | ');
                    shareText += `${m.title}: ${cleanValue} ${m.interpretation}\n`;
                });
                const notes = document.getElementById('doctor-notes').value;
                if (notes.trim()) {
                    shareText += `\n== Notas para mi médico ==\n${notes}`;
                }
                copyToClipboard(shareText, "Resultados de adulto copiados.");
            }
        }

        function copyPediatricResults() { if (Object.keys(currentPediatricResults).length === 0 || isNaN(currentPediatricResults.bmiPercentile.value)) { showToast("Calcula los resultados pediátricos primero.", true); return; } const { bmiPercentile, bodyFat, geb } = currentPediatricResults; const notes = document.getElementById('pediatric-doctor-notes').value; let shareText = "--- Resumen de salud pediátrica ---\n\n"; shareText += `== Indicadores ==\n`; shareText += `IMC por percentil: ${bmiPercentile.value} (${bmiPercentile.interpretation})\n`; shareText += `% Grasa corporal (Slaughter): ${isNaN(bodyFat.value) ? '-' : bodyFat.value.toFixed(1) + '%'} (${bodyFat.interpretation})\n`; shareText += `Gasto energético basal: ${isNaN(geb.value) ? '-' : geb.value.toFixed(0)} kcal/día (${geb.interpretation})\n\n`; if (notes.trim() !== '') { shareText += `== Notas para el pediatra ==\n${notes}\n`; } copyToClipboard(shareText, 'Resultados pediátricos copiados.'); }
        
        // --- LÓGICA DE LA CALCULADORA DE DOSIS ---
        const doseInputElementsNew = {
            peso: document.getElementById('dosis-peso-new'),
            posologia: document.getElementById('dosis-posologia-new'),
            frecuencia: document.getElementById('dosis-frecuencia-new'),
            presentacion: document.getElementById('dosis-presentacion-new'),
            concMg: document.getElementById('dosis-concentracion-mg-new'),
            concMl: document.getElementById('dosis-concentracion-ml-new'),
            mgUnidad: document.getElementById('dosis-mg-unidad-new'),
            utilMg: document.getElementById('dosis-util-mg-new'),
            utilMl: document.getElementById('dosis-util-ml-new')
        };
        const doseFieldLiquidoNew = document.getElementById('dosis-field-liquido-new');
        const doseFieldSolidoNew = document.getElementById('dosis-field-solido-new');
        const doseDiaResultNew = document.getElementById('dosis-dia-result-new');
        const doseTomaResultNew = document.getElementById('dosis-toma-result-new');
        const doseMgmlResultNew = document.getElementById('dosis-mgml-result-new');
        
        const medsDB = {
            "Analgésicos y antipiréticos": [
                { id: "PAR001", nombre: "Paracetamol Gotas 100 mg/ml", posologia: 60, frecuencia: 4, presentacion: 'gotas', concMg: 100, concMl: 1 },
                { id: "PAR002", nombre: "Paracetamol Jarabe 120 mg/5 ml", posologia: 60, frecuencia: 4, presentacion: 'solucion', concMg: 120, concMl: 5 },
                { id: "PAR003", nombre: "Paracetamol Jarabe 160 mg/5 ml", posologia: 60, frecuencia: 4, presentacion: 'solucion', concMg: 160, concMl: 5 },
                { id: "PAR004", nombre: "Paracetamol Comprimidos 500 mg", posologia: 0, frecuencia: 3, presentacion: 'comprimidos', mgUnidad: 500 },
                { id: "IBU001", nombre: "Ibuprofeno Suspensión 2% (100mg/5ml)", posologia: 30, frecuencia: 3, presentacion: 'solucion', concMg: 100, concMl: 5 },
                { id: "IBU002", nombre: "Ibuprofeno Suspensión 4% (200mg/5ml)", posologia: 30, frecuencia: 3, presentacion: 'solucion', concMg: 200, concMl: 5 },
                { id: "IBU003", nombre: "Ibuprofeno Comprimidos 400 mg", posologia: 0, frecuencia: 3, presentacion: 'comprimidos', mgUnidad: 400 },
                { id: "NAP001", nombre: "Naproxeno Sódico 125 mg/5 ml", posologia: 7.5, frecuencia: 3, presentacion: 'solucion', concMg: 125, concMl: 5 },
                { id: "DIC001", nombre: "Diclofenac Potásico Gotas 15 mg/ml", posologia: 1.5, frecuencia: 3, presentacion: 'gotas', concMg: 15, concMl: 1 },
                { id: "DIC002", nombre: "Diclofenac Potásico Comprimidos 25 mg", posologia: 0, frecuencia: 2, presentacion: 'comprimidos', mgUnidad: 25 },
                { id: "ASP001", nombre: "Ácido Acetilsalicílico 500 mg (Adultos)", posologia: 0, frecuencia: 4, presentacion: 'comprimidos', mgUnidad: 500 },
            ],
            "Afecciones respiratorias": [
                { id: "LOR001", nombre: "Loratadina Jarabe 5 mg/5 ml", posologia: 0, frecuencia: 1, presentacion: 'solucion', concMg: 5, concMl: 5 },
                { id: "LOR002", nombre: "Loratadina Comprimidos 10 mg", posologia: 0, frecuencia: 1, presentacion: 'comprimidos', mgUnidad: 10 },
                { id: "CET001", nombre: "Cetirizina Gotas 10 mg/ml", posologia: 0, frecuencia: 2, presentacion: 'gotas', concMg: 10, concMl: 1 },
                { id: "CET002", nombre: "Cetirizina Jarabe 5 mg/5 ml", posologia: 0, frecuencia: 2, presentacion: 'solucion', concMg: 5, concMl: 5 },
                { id: "CET003", nombre: "Cetirizina Comprimidos 10 mg", posologia: 0, frecuencia: 1, presentacion: 'comprimidos', mgUnidad: 10 },
                { id: "DES001", nombre: "Desloratadina Jarabe 2.5 mg/5 ml", posologia: 0, frecuencia: 1, presentacion: 'solucion', concMg: 2.5, concMl: 5 },
                { id: "DES002", nombre: "Desloratadina Comprimidos 5 mg", posologia: 0, frecuencia: 1, presentacion: 'comprimidos', mgUnidad: 5 },
                { id: "FEX001", nombre: "Fexofenadina Suspensión 30 mg/5 ml", posologia: 0, frecuencia: 2, presentacion: 'solucion', concMg: 30, concMl: 5 },
                { id: "DIF001", nombre: "Difenhidramina Jarabe 12.5 mg/5 ml", posologia: 5, frecuencia: 4, presentacion: 'solucion', concMg: 12.5, concMl: 5 },
                { id: "FEN001", nombre: "Fenilefrina Jarabe 2.5 mg/5 ml", posologia: 1, frecuencia: 4, presentacion: 'solucion', concMg: 2.5, concMl: 5 },
                { id: "PSE001", nombre: "Pseudoefedrina Jarabe 5 mg/ml", posologia: 4, frecuencia: 3, presentacion: 'solucion', concMg: 5, concMl: 1 },
                { id: "AMB001", nombre: "Ambroxol Jarabe 15 mg/5 ml", posologia: 1.5, frecuencia: 3, presentacion: 'solucion', concMg: 15, concMl: 5 },
                { id: "AMB002", nombre: "Ambroxol Jarabe 30 mg/5 ml", posologia: 1.5, frecuencia: 3, presentacion: 'solucion', concMg: 30, concMl: 5 },
                { id: "BRO001", nombre: "Bromhexina Jarabe 4 mg/5 ml", posologia: 0.5, frecuencia: 3, presentacion: 'solucion', concMg: 4, concMl: 5 },
                { id: "DEX001", nombre: "Dextrometorfano Jarabe 15 mg/5 ml", posologia: 1, frecuencia: 3, presentacion: 'solucion', concMg: 15, concMl: 5 },
                { id: "GUA001", nombre: "Guaifenesina Jarabe 100 mg/5 ml", posologia: 15, frecuencia: 4, presentacion: 'solucion', concMg: 100, concMl: 5 },
            ],
            "Alivio digestivo": [
                { id: "ALM001", nombre: "Hidróxido de Al/Mg Suspensión", posologia: 0, frecuencia: 4, presentacion: 'solucion', concMg: 400, concMl: 5 },
                { id: "CAR002", nombre: "Carbonato de Calcio Masticable 500 mg", posologia: 0, frecuencia: 4, presentacion: 'comprimidos', mgUnidad: 500 },
                { id: "HIOS001", nombre: "Butilbromuro de Hioscina 10 mg", posologia: 0, frecuencia: 4, presentacion: 'comprimidos', mgUnidad: 10 },
                { id: "TRIM001", nombre: "Trimebutina Suspensión 24 mg/5 ml", posologia: 12, frecuencia: 3, presentacion: 'solucion', concMg: 24, concMl: 5 },
                { id: "TRIM002", nombre: "Trimebutina Comprimidos 200 mg", posologia: 0, frecuencia: 3, presentacion: 'comprimidos', mgUnidad: 200 },
                { id: "LOP001", nombre: "Loperamida 2 mg", posologia: 0, frecuencia: 4, presentacion: 'comprimidos', mgUnidad: 2 },
                { id: "BAC001", nombre: "Enterogermina (Bacillus Clausii)", posologia: 0, frecuencia: 2, presentacion: 'solucion', concMg: 2000000000, concMl: 5 },
                { id: "LAC001", nombre: "Lactulosa Jarabe", posologia: 0, frecuencia: 2, presentacion: 'solucion', concMg: 66.6, concMl: 100 },
                { id: "BIS001", nombre: "Bisacodilo 5mg", posologia: 0, frecuencia: 1, presentacion: 'comprimidos', mgUnidad: 5},
                { id: "POL001", nombre: "Polietilenglicol 3350", posologia: 0, frecuencia: 1, presentacion: 'sobres'},
                { id: "SIM001", nombre: "Simeticona Gotas", posologia: 0, frecuencia: 3, presentacion: 'gotas'},
                { id: "SIM002", nombre: "Simeticona Comprimidos 80 mg", posologia: 0, frecuencia: 3, presentacion: 'comprimidos', mgUnidad: 80 },
            ],
            "Sales de rehidratación oral": [
                { id: "SRO001", nombre: "Sales de Rehidratación Oral (OMS)", posologia: 0, frecuencia: 1, presentacion: 'sobres' },
            ],
            "Medicamentos tópicos": [
                { id: "CLO001", nombre: "Clotrimazol Crema 1%", posologia: 0, frecuencia: 2, presentacion: 'solucion' },
                { id: "MIC001", nombre: "Miconazol Crema 2%", posologia: 0, frecuencia: 2, presentacion: 'solucion' },
                { id: "TER001", nombre: "Terbinafina Crema 1%", posologia: 0, frecuencia: 1, presentacion: 'solucion' },
                { id: "POV001", nombre: "Povidona Yodada Solución 10%", posologia: 0, frecuencia: 1, presentacion: 'solucion' },
                { id: "CHX001", nombre: "Clorhexidina Solución 1%", posologia: 0, frecuencia: 2, presentacion: 'solucion' },
                { id: "BEN001", nombre: "Peróxido de Benzoilo 5%", posologia: 0, frecuencia: 2, presentacion: 'solucion' },
                { id: "SAL001", nombre: "Ácido Salicílico 2%", posologia: 0, frecuencia: 2, presentacion: 'solucion' },
            ],
            "Medicamentos oftálmicos": [
                { id: "KET001", nombre: "Ketotifeno Colirio 0.25 mg/ml", posologia: 0, frecuencia: 2, presentacion: 'gotas', concMg: 0.25, concMl: 1 },
                { id: "CAR001", nombre: "Carboximetilcelulosa Colirio 0.5%", posologia: 0, frecuencia: 4, presentacion: 'gotas', concMg: 5, concMl: 1 },
            ]
        };

        const medsModal = document.getElementById('meds-modal');
        const openMedsListBtn = document.getElementById('open-meds-list-btn');
        const closeMedsModalBtn = document.getElementById('close-meds-modal-btn');
        const medsListContainer = document.getElementById('meds-list-container');
        const fixedDoseNote = document.getElementById('fixed-dose-note');
        
        function openMedsModal() { medsModal.classList.remove('hidden'); }
        function closeMedsModal() { medsModal.classList.add('hidden'); }
        
        function populateMedsList() {
            medsListContainer.innerHTML = '';
            for (const category in medsDB) {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'mb-4';

                const header = document.createElement('button');
                header.className = 'accordion-header w-full text-left p-3 bg-gray-100 hover:bg-gray-200 font-bold text-lg text-gray-700 flex justify-between items-center transition-colors rounded-t-lg';
                header.innerHTML = `<span>${category}</span><svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                
                const content = document.createElement('div');
                content.className = 'accordion-content bg-white border border-t-0 rounded-b-lg';
                
                const list = document.createElement('div');
                medsDB[category].forEach(med => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'block px-4 py-3 text-sm text-gray-800 hover:bg-[#F7F9F4] transition-colors border-b last:border-b-0';
                    item.textContent = med.nombre;
                    item.dataset.medId = med.id;
                    item.dataset.category = category;
                    list.appendChild(item);
                });
                
                content.appendChild(list);
                categoryWrapper.appendChild(header);
                categoryWrapper.appendChild(content);
                medsListContainer.appendChild(categoryWrapper);
            }
        }
        
        function autoFillDoseCalculator(medId, category) {
            const med = medsDB[category].find(m => m.id === medId);
            if (!med) return;
            
            const posologiaInput = doseInputElementsNew.posologia;

            if (med.posologia === 0) {
                posologiaInput.value = '';
                posologiaInput.placeholder = 'Dosis Fija';
                posologiaInput.disabled = true;
                fixedDoseNote.classList.remove('hidden');
            } else {
                posologiaInput.value = med.posologia;
                posologiaInput.placeholder = '30';
                posologiaInput.disabled = false;
                fixedDoseNote.classList.add('hidden');
            }

            doseInputElementsNew.frecuencia.value = med.frecuencia;
            doseInputElementsNew.presentacion.value = med.presentacion;
            
            const event = new Event('change');
            doseInputElementsNew.presentacion.dispatchEvent(event);

            doseInputElementsNew.concMg.value = med.concMg || '';
            doseInputElementsNew.concMl.value = med.concMl || '';
            doseInputElementsNew.mgUnidad.value = med.mgUnidad || '';
            
            if (med.id.includes("IBU") || med.id.includes("PAR")) {
                showToast("Advertencia: No alterne Paracetamol e Ibuprofeno sin indicación médica.", true)
            }
            
            calculateDoseMetricsNew();
            closeMedsModal();
        }

        medsListContainer.addEventListener('click', function(e) {
            if (e.target.dataset.medId) {
                e.preventDefault();
                autoFillDoseCalculator(e.target.dataset.medId, e.target.dataset.category);
            }
        });

        openMedsListBtn.addEventListener('click', openMedsModal);
        closeMedsModalBtn.addEventListener('click', closeMedsModal);
        medsModal.addEventListener('click', (e) => {
            if (e.target === medsModal) {
                closeMedsModal();
            }
        });

        function handlePresentationChangeNew() {
            const selectedType = doseInputElementsNew.presentacion.value;
            const isLiquid = ['solucion', 'gotas', 'inyectables'].includes(selectedType);
            doseFieldLiquidoNew.classList.toggle('hidden', !isLiquid);
            doseFieldSolidoNew.classList.toggle('hidden', isLiquid);
            calculateDoseMetricsNew();
        }

        function calculateConcentrationNew() {
            const mg = parseFloat(doseInputElementsNew.utilMg.value);
            const ml = parseFloat(doseInputElementsNew.utilMl.value);
            if (!isNaN(mg) && !isNaN(ml) && ml > 0) {
                doseMgmlResultNew.textContent = `Resultado: ${(mg / ml).toFixed(2)} mg/ml`;
            } else {
                doseMgmlResultNew.textContent = 'Resultado: - mg/ml';
            }
        }
        
        function calculateDoseMetricsNew() {
            const peso = parseFloat(doseInputElementsNew.peso.value);
            const posologia = parseFloat(doseInputElementsNew.posologia.value);
            const numDoses = parseFloat(doseInputElementsNew.frecuencia.value);
            const presentacion = doseInputElementsNew.presentacion.value;
            const posologiaInput = doseInputElementsNew.posologia;

            if (posologiaInput.disabled) { // Fixed dose logic
                doseDiaResultNew.textContent = 'Dosis Fija';
                doseTomaResultNew.textContent = 'Verificar prospecto';
                return;
            }

            if (isNaN(peso) || isNaN(posologia) || isNaN(numDoses) || peso <= 0 || numDoses <= 0) {
                doseDiaResultNew.textContent = '-';
                doseTomaResultNew.textContent = '-';
                return;
            }

            const totalDoseMgDay = peso * posologia;
            const dosePerTakeMg = totalDoseMgDay / numDoses;
            doseDiaResultNew.innerHTML = `${totalDoseMgDay.toFixed(2)} mg`;
            let resultToma = `${dosePerTakeMg.toFixed(2)} mg`;
            
            if (['solucion', 'gotas', 'inyectables'].includes(presentacion)) {
                const concMg = parseFloat(doseInputElementsNew.concMg.value);
                const concMl = parseFloat(doseInputElementsNew.concMl.value);
                if(!isNaN(concMg) && !isNaN(concMl) && concMg > 0) {
                    const volumePerTakeMl = (dosePerTakeMg * concMl) / concMg;
                    resultToma += ` <br class="sm:hidden"> <span class="text-gray-600 font-normal">(${volumePerTakeMl.toFixed(2)} ml)</span>`;
                    if (presentacion === 'gotas') {
                        const drops = volumePerTakeMl * 20; // Asumiendo 20 gotas/ml
                        resultToma += ` <br class="sm:hidden"> <span class="text-gray-500 font-normal">≈ ${drops.toFixed(0)} gotas</span>`;
                    }
                }
            } else { // Sólidos
                 const mgUnidad = parseFloat(doseInputElementsNew.mgUnidad.value);
                 if(!isNaN(mgUnidad) && mgUnidad > 0) {
                     const units = dosePerTakeMg / mgUnidad;
                     let unitName = presentacion.slice(0, -1);
                     if (units !== 1) unitName = presentacion;
                     resultToma += ` <br class="sm:hidden"> <span class="text-gray-600 font-normal">(${units.toFixed(2)} ${unitName})</span>`;
                 }
            }
            doseTomaResultNew.innerHTML = resultToma;
        }
        
        function copyDoseResults() {
            const peso = parseFloat(doseInputElementsNew.peso.value);
            let posologia = parseFloat(doseInputElementsNew.posologia.value);
            const numDoses = parseFloat(doseInputElementsNew.frecuencia.value);
            const frecuenciaEl = doseInputElementsNew.frecuencia;
            const frecuenciaText = frecuenciaEl.options[frecuenciaEl.selectedIndex].text;
            const presentacionEl = doseInputElementsNew.presentacion;
            const presentacionValue = presentacionEl.value;
            const presentacionText = presentacionEl.options[presentacionEl.selectedIndex].text;
            const isFixedDose = doseInputElementsNew.posologia.disabled;

            if (isNaN(peso) && !isFixedDose) {
                 showToast("Por favor, introduce el peso del paciente.", true);
                 return;
            }
            if(isNaN(posologia) && !isFixedDose) {
                showToast("Por favor, completa la posología.", true);
                return;
            }

            let shareText = "--- Resumen de cálculo de dosis ---\n\n";
            shareText += `== Datos de la prescripción ==\n`;
            if (!isNaN(peso)) shareText += `Peso del paciente: ${peso} kg\n`;
            if (!isFixedDose) {
                shareText += `Posología: ${posologia} mg/kg/día\n`;
            }
            shareText += `Frecuencia: ${frecuenciaText}\n\n`;

            shareText += `== Datos del medicamento ==\n`;
            shareText += `Presentación: ${presentacionText}\n`;
            
            const isLiquid = ['solucion', 'gotas', 'inyectables'].includes(presentacionValue);
            if (isLiquid) {
                const concMg = parseFloat(doseInputElementsNew.concMg.value);
                const concMl = parseFloat(doseInputElementsNew.concMl.value);
                if(!isNaN(concMg) && !isNaN(concMl) && concMg > 0) {
                    shareText += `Concentración: ${concMg} mg / ${concMl} ml\n\n`;
                } else {
                    shareText += `Concentración: No especificada\n\n`;
                }
            } else { // Sólidos
                const mgUnidad = parseFloat(doseInputElementsNew.mgUnidad.value);
                if(!isNaN(mgUnidad) && mgUnidad > 0) {
                    shareText += `Concentración: ${mgUnidad} mg por unidad\n\n`;
                } else {
                    shareText += `Concentración: No especificada\n\n`;
                }
            }

            shareText += `== Resultados ==\n`;
             if (!isFixedDose) {
                const totalDoseMgDay = peso * posologia;
                const dosePerTakeMg = totalDoseMgDay / numDoses;
                let dosisTomaText = `${dosePerTakeMg.toFixed(2)} mg`;

                if (isLiquid) {
                    const concMg = parseFloat(doseInputElementsNew.concMg.value);
                    const concMl = parseFloat(doseInputElementsNew.concMl.value);
                    if(!isNaN(concMg) && !isNaN(concMl) && concMg > 0) {
                        const volumePerTakeMl = (dosePerTakeMg * concMl) / concMg;
                        dosisTomaText += ` (${volumePerTakeMl.toFixed(2)} ml)`;
                        if (presentacionValue === 'gotas') {
                            const drops = volumePerTakeMl * 20;
                            dosisTomaText += ` ≈ ${drops.toFixed(0)} gotas`;
                        }
                    }
                } else {
                     const mgUnidad = parseFloat(doseInputElementsNew.mgUnidad.value);
                     if(!isNaN(mgUnidad) && mgUnidad > 0) {
                         const units = dosePerTakeMg / mgUnidad;
                         let unitName = presentacionValue.slice(0, -1);
                         if (units !== 1) unitName = presentacionValue;
                         dosisTomaText += ` (${units.toFixed(2)} ${unitName})`;
                     }
                }
                shareText += `Dosis diaria total: ${totalDoseMgDay.toFixed(2)} mg\n`;
                shareText += `Dosis por toma: ${dosisTomaText}\n`;
            } else {
                shareText += `Dosis: Dosis fija. Según indicación del prospecto o profesional.\n`;
            }

            copyToClipboard(shareText, "Resultados de dosis copiados.");
        }
        
        Object.values(doseInputElementsNew).forEach(input => {
            if (input.id !== 'dosis-posologia-new') {
                 input.addEventListener('input', calculateDoseMetricsNew);
            }
        });
        
        doseInputElementsNew.posologia.addEventListener('input', () => {
             if (!doseInputElementsNew.posologia.disabled) {
                fixedDoseNote.classList.add('hidden');
                calculateDoseMetricsNew();
            }
        });

        doseInputElementsNew.presentacion.addEventListener('change', handlePresentationChangeNew);
        doseInputElementsNew.utilMg.addEventListener('input', calculateConcentrationNew);
        doseInputElementsNew.utilMl.addEventListener('input', calculateConcentrationNew);

        // --- LÓGICA DE LA CALCULADORA DE SALUD MENTAL (CORREGIDA) ---
        const mh = {
            consent: document.getElementById('mh-consent'),
            prevBtn: document.getElementById('mh-prev-btn'),
            nextBtn: document.getElementById('mh-next-btn'),
            steps: document.querySelectorAll('.mh-step'),
            progressText: document.getElementById('mh-progress-text'),
            progressPercent: document.getElementById('mh-progress-percent'),
            progressBar: document.getElementById('mh-progress-bar'),
            questionnairesContainer: document.getElementById('mh-questionnaires-container'),
            resultsContainer: document.getElementById('mh-results-container'),
            actionItems: document.getElementById('mh-action-items'),
            copyBtn: document.getElementById('mh-copyBtn'),
            counterWrapper: document.getElementById('mh-question-counter-wrapper'),
            counterText: document.getElementById('mh-question-counter'),
            currentStep: 1,
            totalSteps: 4,
            finalScores: {},
            contextData: {}
        };

        const questionnairesDB = {
            phq9: {
                title: "PHQ-9 (Depresión)",
                instructions: "Durante las últimas 2 semanas, ¿con qué frecuencia le han molestado los siguientes problemas?",
                questions: [
                    "Poco interés o placer en hacer las cosas.",
                    "Sentirse decaído(a), deprimido(a) o sin esperanzas.",
                    "Problemas para quedarse o permanecer dormido(a), o dormir demasiado.",
                    "Sentirse cansado(a) o con poca energía.",
                    "Poco apetito o comer en exceso.",
                    "Sentirse mal consigo mismo(a) – o que es un fracaso o que ha decepcionado a su familia o a sí mismo(a).",
                    "Problemas para concentrarse en cosas, como leer el periódico o ver la televisión.",
                    "Moverse o hablar tan lentamente que otras personas podrían haberlo notado. O lo contrario – estar tan inquieto(a) o agitado(a) que se ha estado moviendo mucho más de lo habitual.",
                    "Pensamientos de que estaría mejor muerto(a) o de hacerse daño de alguna manera."
                ],
                options: [
                    { text: "Para nada", value: 0 },
                    { text: "Varios días", value: 1 },
                    { text: "Más de la mitad", value: 2 },
                    { text: "Casi todos", value: 3 }
                ],
                getInterpretation: (score) => {
                    if (score <= 4) return { level: 'Mínima', text: 'Depresión mínima o ausente.', className: 'level-minima' };
                    if (score <= 9) return { level: 'Leve', text: 'Depresión leve.', className: 'level-leve' };
                    if (score <= 14) return { level: 'Moderada', text: 'Depresión moderada.', className: 'level-moderada' };
                    if (score <= 19) return { level: 'Moderadamente severa', text: 'Depresión moderadamente severa.', className: 'level-moderadamente-severa' };
                    return { level: 'Severa', text: 'Depresión severa.', className: 'level-severa' };
                }
            },
            gad7: {
                title: "GAD-7 (Ansiedad)",
                instructions: "Durante las últimas 2 semanas, ¿con qué frecuencia le han molestado los siguientes problemas?",
                questions: [
                    "Sentirse nervioso(a), ansioso(a) o con los nervios de punta.",
                    "No ser capaz de detener o controlar la preocupación.",
                    "Preocuparse demasiado por diferentes cosas.",
                    "Dificultad para relajarse.",
                    "Estar tan inquieto(a) que es difícil quedarse quieto(a).",
                    "Molestarse o irritarse fácilmente.",
                    "Sentir miedo como si algo terrible pudiera suceder."
                ],
                options: [
                    { text: "Para nada", value: 0 },
                    { text: "Varios días", value: 1 },
                    { text: "Más de la mitad", value: 2 },
                    { text: "Casi todos", value: 3 }
                ],
                getInterpretation: (score) => {
                    if (score <= 4) return { level: 'Mínima', text: 'Ansiedad mínima.', className: 'level-minima' };
                    if (score <= 9) return { level: 'Leve', text: 'Ansiedad leve.', className: 'level-leve' };
                    if (score <= 14) return { level: 'Moderada', text: 'Ansiedad moderada.', className: 'level-moderada' };
                    return { level: 'Severa', text: 'Ansiedad severa.', className: 'level-severa' };
                }
            },
            pss10: {
                title: "PSS-10 (Estrés percibido)",
                instructions: "Las siguientes preguntas se refieren a sus sentimientos y pensamientos durante el último mes.",
                questions: [
                    "¿Con qué frecuencia se ha sentido afectado(a) por algo que ha ocurrido inesperadamente?",
                    "¿Con qué frecuencia ha sentido que no podía controlar las cosas importantes en su vida?",
                    "¿Con qué frecuencia se ha sentido nervioso(a) y estresado(a)?",
                    "¿Con qué frecuencia ha sentido confianza en su capacidad para manejar sus problemas personales?", // Invertido
                    "¿Con qué frecuencia ha sentido que las cosas le salían bien?", // Invertido
                    "¿Con qué frecuencia ha sentido que no podía afrontar todas las cosas que tenía que hacer?",
                    "¿Con qué frecuencia ha podido controlar las irritaciones en su vida?", // Invertido
                    "¿Con qué frecuencia se ha sentido que estaba al tanto de las cosas?", // Invertido
                    "¿Con qué frecuencia se ha enfadado por cosas que estaban fuera de su control?",
                    "¿Con qué frecuencia ha sentido que las dificultades se acumulaban tanto que no podía superarlas?"
                ],
                options: [
                    { text: "Nunca", value: 0 }, { text: "Casi nunca", value: 1 }, { text: "A veces", value: 2 }, { text: "A menudo", value: 3 }, { text: "Muy a menudo", value: 4 }
                ],
                invertedIndices: [3, 4, 6, 7],
                getInterpretation: (score) => {
                    if (score <= 13) return { level: 'Bajo', text: 'Nivel de estrés bajo.', className: 'level-baja' };
                    if (score <= 26) return { level: 'Moderado', text: 'Nivel de estrés moderado.', className: 'level-moderada' };
                    return { level: 'Alto', text: 'Nivel de estrés alto percibido.', className: 'level-alta' };
                }
            },
            rse: {
                title: "RSE (Autoestima de Rosenberg)",
                instructions: "Indique su grado de acuerdo con las siguientes afirmaciones.",
                questions: [
                    "En general, estoy satisfecho(a) conmigo mismo(a).",
                    "A veces pienso que no soy bueno(a) en absoluto.", // Invertido
                    "Siento que tengo varias cualidades buenas.",
                    "Soy capaz de hacer las cosas tan bien como la mayoría de la gente.",
                    "Siento que no tengo mucho de qué enorgullecerme.", // Invertido
                    "Ciertamente, a veces me siento inútil.", // Invertido
                    "Siento que soy una persona de valía, al menos en igual medida que los demás.",
                    "Desearía tener más respeto por mí mismo(a).", // Invertido
                    "En general, me inclino a pensar que soy un(a) fracasado(a).", // Invertido
                    "Tengo una actitud positiva hacia mí mismo(a)."
                ],
                options: [
                    { text: "Muy en desacuerdo", value: 0 }, { text: "En desacuerdo", value: 1 }, { text: "De acuerdo", value: 2 }, { text: "Muy de acuerdo", value: 3 }
                ],
                invertedIndices: [1, 4, 5, 7, 8],
                getInterpretation: (score) => {
                    if (score <= 15) return { level: 'Baja', text: 'Baja autoestima.', className: 'level-baja' };
                    if (score <= 25) return { level: 'Normal', text: 'Autoestima en el rango normal/medio.', className: 'level-normal' };
                    return { level: 'Alta', text: 'Alta autoestima.', className: 'level-alta' };
                }
            },
            cdrisc10: {
                title: "CD-RISC-10 (Resiliencia)",
                instructions: "Indique qué tan ciertas son estas afirmaciones para usted.",
                questions: [
                    "Soy capaz de adaptarme cuando ocurren cambios.", "Puedo lidiar con lo que se me presente.", "Trato de ver el lado humorístico de las cosas cuando me enfrento a problemas.", "Tener que lidiar con el estrés puede fortalecerme.", "Tiendo a recuperarme después de una enfermedad, lesión u otras dificultades.", "Creo que puedo alcanzar mis metas, incluso si hay obstáculos.", "Bajo presión, me mantengo enfocado(a) y pienso con claridad.", "No me desanimo fácilmente por el fracaso.", "Me considero una persona fuerte al enfrentar los desafíos y dificultades de la vida.", "Soy capaz de manejar sentimientos desagradables o dolorosos como la tristeza, el miedo y la ira."
                ],
                options: [
                    { text: "Nada cierto", value: 0 }, { text: "Raramente", value: 1 }, { text: "A veces", value: 2 }, { text: "A menudo", value: 3 }, { text: "Casi siempre", value: 4 }
                ],
                getInterpretation: (score) => {
                    if (score <= 28) return { level: 'Baja', text: 'Nivel de resiliencia bajo a moderado.', className: 'level-baja' };
                    if (score <= 34) return { level: 'Promedio', text: 'Nivel de resiliencia promedio.', className: 'level-promedio' };
                    return { level: 'Alta', text: 'Nivel de resiliencia alto.', className: 'level-alta' };
                }
            },
            pcl5: {
                title: "PCL-5 (TEPT)",
                instructions: "En el último mes, ¿cuánto le han molestado los siguientes problemas relacionados con su experiencia traumática?",
                questions: [
                    "¿Recuerdos, sueños o flashbacks repetidos y angustiantes del evento estresante?", "¿Evitar recuerdos, pensamientos o sentimientos relacionados con el evento?", "¿Evitar recordatorios externos (personas, lugares, conversaciones) del evento?", "¿Tener dificultad para recordar partes importantes del evento?", "¿Tener pensamientos negativos sobre usted mismo, los demás o el mundo?", "¿Culparse a sí mismo o a otros por el evento o sus consecuencias?", "¿Sentir emociones negativas persistentes (miedo, ira, culpa, vergüenza)?", "¿Pérdida de interés en actividades que antes disfrutaba?", "¿Sentirse distante o alejado de los demás?", "¿Incapacidad para experimentar emociones positivas?", "¿Comportamiento irritable y arrebatos de ira?", "¿Comportamiento imprudente o autodestructivo?", "¿Estar hipervigilante, siempre en guardia?", "¿Sobresaltarse fácilmente?", "¿Problemas de concentración?", "¿Dificultad para dormir?"
                ],
                options: [
                    { text: "Para nada", value: 0 }, { text: "Un poco", value: 1 }, { text: "Moderado", value: 2 }, { text: "Bastante", value: 3 }, { text: "Extremo", value: 4 }
                ],
                getInterpretation: (score) => {
                     if (score <= 32) return { level: 'Bajo', text: 'Baja probabilidad de TEPT.', className: 'level-baja' };
                     return { level: 'Alto', text: 'Puntuación sugestiva de TEPT. Se recomienda evaluación profesional.', className: 'level-alta' };
                }
            }
        };

        function renderQuestionnaire(key) {
            const qData = questionnairesDB[key];
            const hasMultipleOptions = qData.options.length > 4;
            const desktopOptionCols = hasMultipleOptions ? 5 : 4;
            
            let html = `
                <div id="questionnaire-${key}" class="p-4 sm:p-6 border rounded-xl bg-white shadow-sm flex flex-col">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800">${qData.title}</h3>
                        <p class="text-gray-600 mt-1">${qData.instructions}</p>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Header for Desktop View -->
                        <div class="hidden md:grid grid-cols-12 gap-x-4 border-b pb-2">
                            <div class="col-span-7 font-semibold text-gray-600 text-sm">Pregunta</div>
                            <div class="col-span-5 grid grid-cols-${qData.options.length} text-center">
                                ${qData.options.map(option => `<span class="font-semibold text-gray-600 text-xs">${option.text}</span>`).join('')}
                            </div>
                        </div>

                        <!-- Question Rows -->
                        ${qData.questions.map((question, index) => `
                            <!-- Wrapper for each question with bottom border -->
                            <div class="pb-6 border-b last:border-b-0">
                                <!-- Mobile Layout -->
                                <div class="md:hidden">
                                    <p class="font-medium text-gray-800 mb-3">${index + 1}. ${question}</p>
                                    <div class="space-y-2">
                                        ${qData.options.map(option => `
                                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 has-[:checked]:bg-[#F7F9F4] has-[:checked]:border-[#6B8E23] transition-colors cursor-pointer">
                                                <input type="radio" name="${key}-${index}" value="${option.value}" class="h-4 w-4 text-[#6B8E23] focus:ring-[#6B8E23] border-gray-300">
                                                <span class="ml-3 text-gray-700">${option.text}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Desktop Layout -->
                                <div class="hidden md:grid grid-cols-12 gap-x-4 items-center">
                                    <p class="col-span-7 font-medium text-gray-800">${index + 1}. ${question}</p>
                                    <div class="col-span-5 grid grid-cols-${qData.options.length} text-center">
                                        ${qData.options.map(option => `
                                            <label class="flex justify-center items-center h-8 w-8 mx-auto rounded-full hover:bg-gray-100 cursor-pointer has-[:checked]:bg-[#eef3e6]">
                                                <input type="radio" name="${key}-${index}" value="${option.value}" class="h-5 w-5 text-[#6B8E23] focus:ring-offset-1 focus:ring-[#8FB158] border-gray-400">
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            return html;
        }


        function loadQuestionnaires() {
            let containerHTML = renderQuestionnaire('phq9');
            containerHTML += renderQuestionnaire('gad7');
            containerHTML += renderQuestionnaire('pss10');
            containerHTML += renderQuestionnaire('rse');
            containerHTML += renderQuestionnaire('cdrisc10');

            const traumaTrigger = document.getElementById('mh-trauma-trigger').value;
            if (traumaTrigger === 'si') {
                 containerHTML += renderQuestionnaire('pcl5');
            }

            mh.questionnairesContainer.innerHTML = containerHTML;
        }
        
        function updateMHProgress(step) {
            mh.currentStep = step;
            const percent = mh.totalSteps > 1 ? ((mh.currentStep - 1) / (mh.totalSteps - 1)) * 100 : 100;
            mh.progressText.textContent = `Paso ${mh.currentStep} de ${mh.totalSteps}`;
            mh.progressPercent.textContent = `${Math.round(percent)}%`;
            mh.progressBar.style.width = `${percent}%`;
        }

        function showMHStep(step) {
            mh.steps.forEach(s => s.classList.add('hidden'));
            document.getElementById(`mh-step-${step}`).classList.remove('hidden');
            updateMHProgress(step);

            mh.counterWrapper.classList.toggle('hidden', step !== 3);
            mh.prevBtn.classList.toggle('hidden', step === 1);
            mh.nextBtn.textContent = (step === mh.totalSteps - 1) ? 'Calcular resultados' : 'Siguiente';
            
            if(step === mh.totalSteps){
                mh.prevBtn.classList.add('hidden');
                mh.nextBtn.classList.add('hidden');
            } else {
                 mh.nextBtn.classList.remove('hidden');
            }
            validateMHStep(step);
        }

        function validateMHStep(step) {
            let isValid = false;
            if (step === 1) {
                isValid = mh.consent.checked;
            } else if (step === 2) { 
                isValid = true; // No required fields in this step
            } else if (step === 3) { // Questionnaires step
                const inputs = mh.questionnairesContainer.querySelectorAll('input[type="radio"]');
                const questions = new Set();
                inputs.forEach(input => questions.add(input.name));
                const totalQuestions = questions.size;
                const answeredCount = mh.questionnairesContainer.querySelectorAll('input[type="radio"]:checked').length;
                
                if (totalQuestions > 0) {
                    mh.counterText.innerHTML = `Has respondido <span class="font-bold text-[#6B8E23]">${answeredCount}</span> de <span class="font-bold text-[#6B8E23]">${totalQuestions}</span> preguntas.`;
                }

                isValid = answeredCount === totalQuestions && totalQuestions > 0;
            }
            mh.nextBtn.disabled = !isValid;
        }

        function calculateMHScores() {
            mh.finalScores = {};
            for (const key in questionnairesDB) {
                const form = document.getElementById(`questionnaire-${key}`);
                if (!form) continue;

                let score = 0;
                const qData = questionnairesDB[key];
                const checkedRadios = form.querySelectorAll('input[type="radio"]:checked');

                checkedRadios.forEach((radio, index) => {
                    let value = parseInt(radio.value);
                    if (qData.invertedIndices && qData.invertedIndices.includes(index)) {
                        value = (qData.options.length - 1) - value;
                    }
                    score += value;
                });
                mh.finalScores[key] = {
                    score: score,
                    interpretation: qData.getInterpretation(score)
                };
            }
        }
        
        function generateMHReport() {
            mh.resultsContainer.innerHTML = '';
            mh.actionItems.innerHTML = '';
            
            const orderedKeys = ['phq9', 'gad7', 'pss10', 'rse', 'cdrisc10', 'pcl5'];

            orderedKeys.forEach(key => {
                if (mh.finalScores[key]) {
                    const data = mh.finalScores[key];
                    const qInfo = questionnairesDB[key];
                    
                    const resultCard = `
                        <div class="mh-result-card ${data.interpretation.className}">
                            <h3 class="text-xl font-semibold mb-2">${qInfo.title}</h3>
                            <p class="text-3xl font-bold text-[#6B8E23] mb-1">${data.score} <span class="text-lg font-medium text-gray-600">/ ${qInfo.questions.length * (qInfo.options.length-1)}</span></p>
                            <p class="text-md text-gray-700 font-semibold">${data.interpretation.level}: <span class="font-normal">${data.interpretation.text}</span></p>
                        </div>
                    `;
                    mh.resultsContainer.innerHTML += resultCard;
                }
            });
            generateMHRecommendations();
        }

        function generateMHRecommendations() {
            let suggestionsHTML = '';
            const scores = mh.finalScores;

            if (scores.phq9) {
                if (scores.phq9.score >= 5 && scores.phq9.score <= 9) suggestionsHTML += '<li><strong>Depresión leve:</strong> Considera cambios en el estilo de vida (ejercicio, sueño) y monitorea tu estado de ánimo.</li>';
                if (scores.phq9.score >= 10 && scores.phq9.score <= 14) suggestionsHTML += '<li><strong>Depresión moderada:</strong> Se recomienda buscar psicoterapia (ej. TCC). Considera hablar con un médico sobre farmacoterapia.</li>';
                if (scores.phq9.score >= 15) suggestionsHTML += '<li><strong>Depresión severa:</strong> Es crucial buscar ayuda profesional de inmediato. El tratamiento combinado (terapia y medicación) suele ser más efectivo.</li>';
            }
            if (scores.gad7) {
                if (scores.gad7.score >= 5 && scores.gad7.score <= 9) suggestionsHTML += '<li><strong>Ansiedad leve:</strong> Explora técnicas de manejo de estrés como mindfulness o ejercicios de relajación.</li>';
                if (scores.gad7.score >= 10 && scores.gad7.score <= 14) suggestionsHTML += '<li><strong>Ansiedad moderada:</strong> La psicoterapia, especialmente la TCC, es muy eficaz para la ansiedad.</li>';
                if (scores.gad7.score >= 15) suggestionsHTML += '<li><strong>Ansiedad severa:</strong> Se recomienda encarecidamente la ayuda profesional para un tratamiento intensivo.</li>';
            }
            if (scores.pss10) {
                if (scores.pss10.score >= 14 && scores.pss10.score <= 26) suggestionsHTML += '<li><strong>Estrés moderado:</strong> Identifica las fuentes de estrés y desarrolla habilidades de afrontamiento como la gestión del tiempo y el establecimiento de límites.</li>';
                if (scores.pss10.score >= 27) suggestionsHTML += '<li><strong>Estrés alto:</strong> Considera una intervención formal como terapia para el estrés. Es importante evaluar si coexiste con ansiedad o depresión.</li>';
            }
            if((scores.gad7 && scores.gad7.score >= 10) || (scores.phq9 && scores.phq9.score >= 10)) {
                 suggestionsHTML += '<li class="mt-2 pt-2 border-t"><strong>Conexión mente-cuerpo:</strong> La ansiedad y/o depresión pueden impactar tu salud física. Mencionar estos resultados a tu médico general es un paso importante para un cuidado integral.</li>';
            }

             if (suggestionsHTML === '') {
                   suggestionsHTML = '<li><strong>Resultados en rango saludable:</strong> Tus respuestas sugieren un buen manejo del bienestar emocional. ¡Sigue así!</li>';
             }

            mh.actionItems.innerHTML = suggestionsHTML;
        }

        function copyMHResults() {
             let shareText = "--- Mi perfil de salud mental ---\n\n";
             
             shareText += "== Contexto personal ==\n";
             mh.contextData = {
                historyFamily: document.getElementById('mh-history-family').value,
                historyPersonal: document.getElementById('mh-history-personal').value,
                precipitants: document.getElementById('mh-precipitants').value,
                perpetuators: document.getElementById('mh-perpetuators').value,
                protectives: document.getElementById('mh-protectives').value
            };
             shareText += `Eventos desencadenantes: ${mh.contextData.precipitants || 'No especificado'}\n`;
             shareText += `Factores que mantienen el problema: ${mh.contextData.perpetuators || 'No especificado'}\n`;
             shareText += `Factores protectores: ${mh.contextData.protectives || 'No especificado'}\n\n`;


             shareText += "== Resultados de cuestionarios ==\n";
             const orderedKeys = ['phq9', 'gad7', 'pss10', 'rse', 'cdrisc10', 'pcl5'];
             orderedKeys.forEach(key => {
                 if(mh.finalScores[key]) {
                     const data = mh.finalScores[key];
                     const qInfo = questionnairesDB[key];
                     shareText += `${qInfo.title}: ${data.score} puntos - ${data.interpretation.level} (${data.interpretation.text})\n`;
                 }
             });

             const notes = document.getElementById('mh-professional-notes').value;
             if (notes.trim()) {
                 shareText += `\n== Notas para mi profesional ==\n${notes}`;
             }

             copyToClipboard(shareText, "Resultados de salud mental copiados.");
        }

        mh.consent.addEventListener('change', () => validateMHStep(1));
        
        mh.questionnairesContainer.addEventListener('change', (event) => {
             if (event.target.type === 'radio') {
                validateMHStep(mh.currentStep);
             }
        });
        
        document.getElementById('mh-trauma-trigger').addEventListener('change', () => {
             // Si el usuario está en el paso de los cuestionarios, los recargamos para añadir/quitar PCL-5
            if (mh.currentStep === 3) {
                 loadQuestionnaires();
                 validateMHStep(3); // Re-validar por si se quitaron preguntas
            }
        });

        mh.nextBtn.addEventListener('click', () => {
            if (mh.nextBtn.disabled) return;
            if (mh.currentStep < mh.totalSteps - 1) { 
                if(mh.currentStep === 2) {
                    loadQuestionnaires();
                }
                showMHStep(mh.currentStep + 1);
            } else if (mh.currentStep === mh.totalSteps - 1) { // Paso 3 (cuestionarios)
                calculateMHScores();
                generateMHReport();
                showMHStep(mh.currentStep + 1);
            }
        });

        mh.prevBtn.addEventListener('click', () => {
            if (mh.currentStep > 1) {
                showMHStep(mh.currentStep - 1);
            }
        });
        
        mh.copyBtn.addEventListener('click', copyMHResults);


        // --- EVENT LISTENERS E INICIALIZACIÓN ---
        Object.values(inputElements).forEach(input => { if(input) input.addEventListener('input', calculateAll); });
        inputElements.sexo.addEventListener('change', togglePregnancyOption);
        inputElements.despiertaNoche.addEventListener('change', toggleSleepDetails);
        copyBtn.addEventListener('click', copyResults);
        pediatricCopyBtn.addEventListener('click', copyPediatricResults);
        const doseCopyBtn = document.getElementById('dosis-copyBtn');
        doseCopyBtn.addEventListener('click', copyDoseResults);
        
        togglePregnancyOption();
        calculateAll();
        populateActivities();
        populateMedsList();
        handlePresentationChangeNew();
        calculateDoseMetricsNew();
        calculateConcentrationNew();
        document.getElementById('year').textContent = new Date().getFullYear();
    });
    </script>
</body>
</html>



